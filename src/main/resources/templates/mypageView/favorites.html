<!DOCTYPE html>
<html layout:decorate="~{myPageLayout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:th="http://www.thymeleaf.org">

<!-- Font Awesome CDN for icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>

<style layout:fragment="styles">
    /* 모달 내 지도의 크기 조정 */
    #storeModal .modal-body {
        position: relative;
        padding: 0;
    }

    #storeModal #map {
        width: 100%;
        height: 400px;
    }

    .btn {
        white-space: nowrap;
        height: 38px; /* 고정된 높이를 부여하여 버튼의 세로 길이를 일정하게 유지 */
    }

    .btn i.fa {
        margin-right: 0; /* 아이콘과 텍스트 간격 제거 */
    }
</style>

<div layout:fragment="content">
    <h1 class="mb-4 text-center">내 찜 목록</h1>

    <!-- 검색 버튼 -->
    <div class="d-flex justify-content-end mb-3">
        <!-- 정렬 기준 선택 -->
        <div class="form-inline mb-3 d-flex justify-content-end">
            <label class="mr-2" for="sortBy">정렬 기준:</label>
            <select class="form-control" id="sortBy" style="width: 200px;">
                <option th:selected="${sortBy == 'distance'}" value="distance">거리순</option>
                <option th:selected="${sortBy == 'newest'}" value="newest">최신순</option>
                <option th:selected="${sortBy == 'oldest'}" value="oldest">오래된순</option>
            </select>
        </div>
        <a class="btn btn-secondary" href="/stores/search">다시 검색</a>
    </div>

    <!-- 찜 목록이 없는 경우 -->
    <div class="text-center mt-5" th:if="${#lists.isEmpty(favorites)}">
        <p class="lead text-muted">찜한 상점이 없습니다.</p>
    </div>

    <!-- 찜 목록 테이블 -->
    <div th:unless="${#lists.isEmpty(favorites)}">
        <div class="row">
            <!-- 가게 목록 리스트 출력 -->
            <div class="col-md-4 mb-4" th:each="store : ${favorites}">
                <div class="card h-100">
                    <!-- 가게 사진 -->
                    <a th:href="@{'/stores/' + ${store.storeId}}">
                        <img alt="가게 사진" class="card-img-top img-fluid"
                             th:src="${store.photoUrls[0]}" th:unless="${#lists.isEmpty(store.photoUrls)}">
                    </a>

                    <div class="card-body">
                        <!-- 가게 이름 -->
                        <a class="text-decoration-none text-dark" th:href="@{'/stores/' + ${store.storeId}}">
                            <h5 class="card-title" th:text="${store.name}">가게 이름</h5>
                        </a>

                        <!-- 상세 보기 버튼을 아이콘으로 변경 -->
                        <button class="btn p-0" data-bs-target="#storeModal"
                                data-bs-toggle="modal"
                                th:data-category="${store.category}"
                                th:data-certification="${store.certification}"
                                th:data-description="${store.description}"
                                th:data-detail-address="${store.detailAddress}"
                                th:data-latitude="${store.latitude}"
                                th:data-longitude="${store.longitude}"
                                th:data-name="${store.name}"
                                th:data-phone-number="${store.phoneNumber}"
                                th:data-road-name-address="${store.roadNameAddress}"
                                th:data-store-id="${store.storeId}"
                                th:data-zipcode="${store.zipcode}"
                                type="button">
                            <i class="fa fa-info-circle"></i> <!-- 상세 보기 아이콘 -->
                        </button>

                        <!-- 찜 여부 (하트 아이콘) -->
                        <sec:authorize access="!isAnonymous()">
                            <button class="btn p-0 favorite-btn"
                                    th:classappend="${store.favorited} ? 'text-danger' : 'text-secondary'"
                                    th:data-favorited="${store.favorited}"
                                    th:data-store-id="${store.storeId}"
                                    type="button">
                                <i class="fa" th:classappend="${store.favorited} ? 'fa-heart' : 'fa-heart-o'"></i>
                            </button>
                        </sec:authorize>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 모달 창 템플릿 -->
    <div aria-hidden="true" aria-labelledby="storeModalLabel" class="modal fade" id="storeModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="storeModalLabel">상점 상세 정보</h5>
                    <button aria-label="닫기" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                </div>
                <div class="modal-body">
                    <!-- 상점 정보 -->
                    <div class="p-3">
                        <h3 class="text-center" id="modalStoreName"></h3>
                        <hr>
                        <p><strong>상점 ID:</strong> <span id="modalStoreId"></span></p>
                        <p><strong>카테고리:</strong> <span id="modalCategory"></span></p>
                        <p><strong>인증 정보:</strong> <span id="modalCertification"></span></p>
                        <p><strong>주소:</strong> <span id="modalAddress"></span></p>
                        <p><strong>전화번호:</strong> <span id="modalPhoneNumber"></span></p>
                        <p><strong>설명:</strong> <span id="modalDescription"></span></p>
                    </div>
                    <!-- 네이버 지도 -->
                    <div class="rounded" id="map" style="height: 400px;"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">닫기</button>
                </div>
            </div>
        </div>
    </div>
</div>


<th:block layout:fragment="scripts">
    <!-- 네이버 지도 API 스크립트 로드 -->
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=t06c4jgb48&submodules=geocoder"
            type="text/javascript"></script>

    <!-- 커스텀 JavaScript -->
    <script type="text/javascript">
        $(document).ready(function () {
            // 찜 버튼 클릭 이벤트
            $('.favorite-btn').click(function () {
                var button = $(this);
                var storeId = button.data('store-id');
                var favorited = button.data('favorited');

                if (favorited) {
                    // 찜 취소
                    $.ajax({
                        url: '/api/favorites/' + storeId,
                        type: 'DELETE',
                        success: function (response) {
                            alert(response);
                            button.data('favorited', false);
                            button.find('i').removeClass('fa-heart').addClass('fa-heart-o'); // 빈 하트로 변경
                            button.removeClass('text-danger').addClass('text-secondary'); // 아이콘 색상 변경
                        },
                        error: function (xhr) {
                            alert(xhr.responseText);
                        }
                    });
                } else {
                    // 찜 추가
                    $.ajax({
                        url: '/api/favorites/' + storeId,
                        type: 'POST',
                        success: function (response) {
                            alert(response);
                            button.data('favorited', true);
                            button.find('i').removeClass('fa-heart-o').addClass('fa-heart'); // 꽉 찬 하트로 변경
                            button.removeClass('text-secondary').addClass('text-danger'); // 아이콘 색상 변경
                        },
                        error: function (xhr) {
                            alert(xhr.responseText);
                        }
                    });
                }
            });

            // 정렬 기준 변경 시 페이지 새로고침
            $('#sortBy').change(function () {
                var sortBy = $(this).val();
                window.location.href = '/mypage/favorites?sortBy=' + sortBy;
            });

            // 지도 인스턴스 관리
            var map;
            var marker;

            // 모달 창이 완전히 열렸을 때 지도 초기화
            $('#storeModal').on('shown.bs.modal', function (event) {
                var button = $(event.relatedTarget); // 버튼 요소
                var storeId = button.data('store-id');
                var name = button.data('name');
                var certification = button.data('certification');
                var roadNameAddress = button.data('road-name-address');
                var detailAddress = button.data('detail-address');
                var zipcode = button.data('zipcode');
                var phoneNumber = button.data('phone-number');
                var category = button.data('category');
                var description = button.data('description');
                var longitude = button.data('longitude');
                var latitude = button.data('latitude');

                // 모달 요소 가져오기
                var modal = $(this);
                modal.find('#modalStoreName').text(name);
                modal.find('#modalStoreId').text(storeId);
                modal.find('#modalCategory').text(category);
                modal.find('#modalCertification').text(certification);
                modal.find('#modalAddress').text(roadNameAddress + ', ' + detailAddress + ', ' + zipcode);
                modal.find('#modalPhoneNumber').text(phoneNumber);
                modal.find('#modalDescription').text(description);

                // 네이버 지도 초기화 또는 재설정
                if (!map) {
                    map = new naver.maps.Map('map', {
                        center: new naver.maps.LatLng(latitude, longitude),
                        zoom: 16
                    });
                } else {
                    map.setCenter(new naver.maps.LatLng(latitude, longitude));
                    map.setZoom(16);
                }

                // 기존 마커 제거
                if (marker) {
                    marker.setMap(null);
                }

                // 마커 추가
                marker = new naver.maps.Marker({
                    position: new naver.maps.LatLng(latitude, longitude),
                    map: map
                });

                // 지도 리사이즈 (필요 시)
                naver.maps.Event.trigger(map, 'resize');
            });

            // 모달이 닫힐 때 지도 초기화 (지도 리소스 해제)
            $('#storeModal').on('hidden.bs.modal', function () {
                // 지도 인스턴스를 삭제하거나 초기화하려면 추가 로직 필요
                // 예: 마커 제거
                if (marker) {
                    marker.setMap(null);
                    marker = null;
                }
            });
        });
    </script>
</th:block>
</html>
