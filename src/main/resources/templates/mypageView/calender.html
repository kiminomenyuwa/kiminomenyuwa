<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>식사 기록 캘린더</title>

    <!-- 필수 메타 태그 -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500&display=swap" rel="stylesheet">

    <!-- FullCalendar CSS -->
    <link th:href="@{/fullcalendar/packages/core/main.css}" rel='stylesheet'/>
    <link th:href="@{/fullcalendar/packages/daygrid/main.css}" rel='stylesheet'/>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" th:href="@{/css/CalendarCss/bootstrap.min.css}">

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/CalendarCss/style.css}">
    <link rel="stylesheet" th:href="@{/css/CalendarCss/header.css}">
</head>

<body>
<!-- Header -->
<header class="header">
    <div class="header-left">
        <button class="hamburger-menu" id="hamburger">&#9776;</button>
        <img th:src="@{/images/logosample.png}" alt="사이트 로고" class="logo">
    </div>

    <div class="header-center">
        <div class="search-container">
            <!-- 검색창 왼쪽 -->
            <input type="text" class="search-bar" placeholder="검색어를 입력하세요">

            <!-- 구분 바 -->
            <span class="divider"></span>

            <!-- 위치 텍스트 -->
            <span class="location-text">New York, NY</span>
        </div>
    </div>
    <div class="header-right">
            <span class="user-avatar" id="profile-menu-btn">
                <img th:src="@{/images/avatar.jpg}" alt="User Avatar" class="profile-pic">
            </span>

        <!-- Dropdown Menu -->
        <div class="dropdown-menu" id="dropdown-menu">
            <ul>
                <li><a href="#">마이페이지</a></li>
                <li><a href="#">Find Friends</a></li>
                <li><a href="#">Log Out</a></li>
            </ul>
        </div>
    </div>
</header>

<!-- Hidden Sidebar Menu -->
<div id="sideMenu" class="side-menu">
    <div class="side-menu-content">
        <h3>user name</h3>
        <nav>
            <ul>
                <li><a href="#">link to MyPage</a></li>
                <li><a href="#">link to business page</a></li>
            </ul>
        </nav>
        <a href="#" class="logout">log out</a>
    </div>
</div>

<!-- Overlay -->
<div id="overlay" class="overlay"></div>

<!-- Main Container -->
<div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="profile">
            <img th:src="@{/images/avatar.jpg}" alt="Profile" class="profile-pic">
            <h3>간을 좋아하는 범고래</h3>

            <div class="profile-buttons">
                <div class="button">
                    <div class="icon">
                        <img th:src="@{/images/default-profile.png}" alt="Edit Icon">
                    </div>
                    <span>프로필 편집</span>
                </div>

                <div class="button">
                    <div class="icon">
                        <img th:src="@{/images/default-profile.png}" alt="Add Friend Icon">
                    </div>
                    <span>친구 추가</span>
                </div>
            </div>
        </div>

        <nav>
            <ul>
                <li class="menu-item active">
                    <img th:src="@{/images/default-profile.png}" alt="Profile Icon">
                    <span>내 프로필</span>
                </li>
                <li class="menu-item">
                    <img th:src="@{/images/default-profile.png}" alt="Reviews Icon">
                    <span>내 리뷰</span>
                </li>
                <li class="menu-item">
                    <img th:src="@{/images/default-profile.png}" alt="Drafts Icon">
                    <span>친구</span>
                </li>
                <li class="menu-item">
                    <img th:src="@{/images/default-profile.png}" alt="Collections Icon">
                    <span>컬렉션</span>
                </li>
                <li class="menu-item">
                    <img th:src="@{/images/default-profile.png}" alt="Events Icon">
                    <span>내 이벤트</span>
                </li>
            </ul>
        </nav>
    </div>


    <!-- Main Content -->
    <main class="contents">
        <section class="page-header">
            <h2>캘린더</h2>
        </section>

        <!-- Bootstrap 그리드 시스템을 사용하여 레이아웃 구성 -->
        <div class="row">
            <!-- 캘린더 섹션: 왼쪽 컬럼 (약 8칸) -->
            <div class="col-md-8">
                <!-- calendar content -->
                <div class="content">
                    <div id='calendar'></div>
                </div>
            </div>

            <!-- 예산 섹션: 오른쪽 상단 컬럼 (약 4칸) -->
            <div class="col-md-4">
                <div id="budget-section" style="text-align: left; margin-bottom: 10px;">
                    <label for="monthlyBudget">한 달 예산: </label>
                    <input type="number" id="monthlyBudget" placeholder="예산을 입력하세요" class="form-control">
                    <button id="setBudgetButton" class="btn btn-primary mt-2">예산 설정</button>
                    <div class="mt-3">
                        <span>남은 예산: </span><span id="remainingBudget">0</span>원
                    </div>
                    <!-- 예산 초기화 버튼 -->
                    <button id="initializeBudgetButton" style="margin-top: 10px;" class="btn btn-danger">예산 초기화</button>
                </div>
            </div>
        </div>

        <!-- 날짜를 클릭하면 가게 이름을 입력할 수 있는 폼 -->
        <div id="storeForm" style="display: none; margin-top: 20px;">
            <h2>가게 이름 입력</h2>
            <label for="storeNameInput">가게 이름:</label>
            <input type="text" id="storeNameInput" placeholder="가게 이름을 입력하세요" class="form-control">
            <button id="storeSubmitButton" class="btn btn-success mt-2">확인</button>
        </div>

        <!-- 메뉴를 불러오는 부분 -->
        <div id="menuContainer" style="display: none; margin-top: 20px;">
            <h2>메뉴 목록</h2>
            <div id="menuList"></div>
        </div>
    </main>
</div>

<!-- 프론트엔드 스크립트 -->
<script th:src="@{/js/jquery-3.7.1.min.js}"></script>
<script th:src='@{/fullcalendar/packages/core/main.js}'></script>
<script th:src='@{/fullcalendar/packages/interaction/main.js}'></script>
<script th:src="@{/fullcalendar/packages/daygrid/main.js}"></script>

<!-- Bootstrap JS 및 의존성 (Popper.js) 추가 -->
<script th:src="@{/js/CalendarJs/popper.min.js}"></script>
<script th:src="@{/js/CalendarJs/bootstrap.min.js}"></script>

<!-- 추가적인 스크립트가 필요하면 여기에 추가 -->
<script>
    $(document).ready(function () {
        let currentDate = new Date(); // 현재 날짜
        let selectedDate = null;
        let selectedMenuId = null;
        let monthlyBudget = 0;  // 설정된 예산
        let totalSpent = 0;     // 총 소비 금액

        // 예산을 저장하는 함수
        function saveMonthlyBudget() {
            const currentUserId = '[[${#authentication.name}]]';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1; // JavaScript 월은 0부터 시작

            const formData = {
                userId: currentUserId,
                year: year,
                month: month,
                budget: monthlyBudget
            };

            $.ajax({
                url: '/mypage/api/budget', // 절대 경로로 수정
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function () {
                    console.log(formData);
                    alert('예산이 저장되었습니다.');
                    loadMonthlyBudget(); // 남은 예산 업데이트
                },
                error: function (e) {
                    console.log(JSON.stringify(e));
                    alert('예산 저장에 실패했습니다.');
                }
            });
        }

        // 예산 초기화하는 함수
        function initializeMonthlyBudget() {
            const currentUserId = '[[${#authentication.name}]]';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1; // JavaScript 월은 0부터 시작

            $.ajax({
                url: '/mypage/api/budget/initialize', // 절대 경로로 수정
                method: 'POST',
                data: {
                    year: year,
                    month: month
                },
                success: function () {
                    alert('예산이 초기화되었습니다.');
                    loadMonthlyBudget(); // 초기화 후 예산 다시 불러오기
                },
                error: function (e) {
                    console.log(JSON.stringify(e));
                    alert('예산 초기화에 실패했습니다.');
                }
            });
        }

        // 예산 설정 버튼 클릭 시 예산을 설정하고 저장
        $('#setBudgetButton').on('click', function () {
            monthlyBudget = parseInt($('#monthlyBudget').val()) || 0;  // 예산 설정
            saveMonthlyBudget(); // 예산 저장 호출
        });

        // 예산 초기화 버튼 클릭 시 예산 초기화
        $('#initializeBudgetButton').on('click', function () {
            if (confirm('해당 월의 예산을 0으로 초기화하시겠습니까?')) {
                initializeMonthlyBudget(); // 예산 초기화 호출
            }
        });

        // 남은 예산을 계산하는 함수
        function updateRemainingBudget() {
            const remainingBudget = monthlyBudget - totalSpent;  // 남은 예산 = 예산 - 총 소비 금액
            $('#remainingBudget').text(remainingBudget.toLocaleString());         // 남은 예산 표시
        }

        // 초기 로드 시 예산 불러오기
        function loadMonthlyBudget() {
            const currentUserId = '[[${#authentication.name}]]';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1; // JavaScript 월은 0부터 시작

            $.ajax({
                url: '/mypage/api/budget/remaining', // 절대 경로로 수정
                method: 'GET',
                data: {
                    year: year,
                    month: month
                },
                success: function (data) {
                    console.log('불러온 예산 데이터', data);
                    monthlyBudget = data.budget || 0; // 불러온 예산 설정
                    updateRemainingBudget(); // 남은 예산 업데이트
                },
                error: function (e) {
                    console.log(JSON.stringify(e));
                    console.error('예산을 불러오는 데 실패했습니다.');
                }
            });
        }

        // 식사 기록을 저장하는 함수
        function saveDiningHistory(selectedMenuName, selectedMenuPrice, calendar) {
            const menuId = selectedMenuId;  // 실제 선택된 메뉴 ID로 대체
            // 사용자가 선택한 날짜로 저장하도록 수정
            const diningDate = `${selectedDate}T00:00:00`;
            const currentUserId = '[[${#authentication.name}]]';

            console.log('Selected Date:', selectedDate);
            console.log('Dining Date:', diningDate);

            $.ajax({
                url: '/mypage/api/dining-history', // 절대 경로로 수정
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    userId: currentUserId,
                    menuId: menuId,
                    diningDate: diningDate // 수정된 부분
                }),
                success: function () {
                    alert('식사 기록이 저장되었습니다.');
                    // FullCalendar에 이벤트 추가
                    calendar.addEvent({
                        title: selectedMenuName,
                        start: selectedDate, // 'YYYY-MM-DD' 형식
                        allDay: true
                    });

                    totalSpent += selectedMenuPrice;
                    updateRemainingBudget();
                },
                error: function () {
                    alert('식사 기록을 저장하는 데 실패했습니다.');
                    console.log(currentUserId);
                }
            });
        }

        // 식사 기록 불러오기
        function loadDiningHistory(calendar) {
            const currentUserId = '[[${#authentication.name}]]';
            $.ajax({
                url: '/mypage/api/dining-history', // 절대 경로로 수정
                method: 'GET',
                success: function (data) {
                    console.log(data);
                    data.forEach(record => {
                        const diningDate = new Date(record.diningDate); // ISO 형식의 문자열을 Date 객체로 변환
                        const day = diningDate.getDate();
                        const month = diningDate.getMonth(); // 0부터 시작
                        const year = diningDate.getFullYear();

                        // 해당 연도와 월에 맞는지 확인
                        if (year === currentDate.getFullYear() && month === currentDate.getMonth()) {
                            // 메뉴 ID로 메뉴 이름과 가격을 가져오는 AJAX 호출
                            $.ajax({
                                url: `/mypage/api/menus/${record.menuId}`, // 절대 경로로 수정
                                method: 'GET',
                                success: function (menu) {
                                    const menuName = menu.name;  // 가져온 메뉴 이름
                                    const menuPrice = menu.price;   // 메뉴 가격 추가
                                    console.log('불러온 메뉴 가격:', menuPrice);
                                    // FullCalendar에 이벤트 추가
                                    calendar.addEvent({
                                        title: menuName,
                                        start: diningDate.toISOString().split('T')[0], // 'YYYY-MM-DD' 형식
                                        allDay: true
                                    });
                                    totalSpent += menuPrice;  // 총 소비 금액 업데이트
                                    updateRemainingBudget();  // 남은 예산 업데이트
                                },
                                error: function () {
                                    console.error('Failed to fetch menu name for menuId:', record.menuId);
                                }
                            });
                        }
                    });
                },
                error: function (e) {
                    console.log(JSON.stringify(e));
                    alert('식사 기록을 불러오는 데 실패했습니다.');
                }
            });
        }

        // 가게 이름 입력 후 확인 버튼 클릭 시 메뉴 가져오기
        $('#storeSubmitButton').on('click', function () {
            const storeName = $('#storeNameInput').val();
            if (storeName) {
                // AJAX로 해당 가게의 메뉴 불러오기
                $.ajax({
                    url: '/mypage/api/menus/store', // 절대 경로로 수정
                    method: 'GET',
                    data: {storeName: storeName},
                    success: function (menus) {
                        $('#menuContainer').show();
                        $('#menuList').empty();
                        menus.forEach(menu => {
                            const menuItem = $('<div class="d-flex align-items-center mb-2"></div>').text(menu.name);
                            const selectButton = $('<button></button>')
                                .text('선택')
                                .addClass('btn btn-sm btn-success ml-2')
                                .on('click', function () {
                                    // 선택한 메뉴의 ID와 이름을 저장
                                    selectedMenuId = menu.menuId;

                                    // 선택한 메뉴의 이름과 가격을 사용하여 셀에 표시
                                    const selectedMenuName = menu.name;
                                    const selectedMenuPrice = menu.price;

                                    // 메뉴 가격도 추가
                                    saveDiningHistory(selectedMenuName, selectedMenuPrice, calendar); // 선택된 메뉴 이름으로 저장 호출
                                });
                            $('#menuList').append(menuItem).append(selectButton);
                        });
                    },
                    error: function (e) {
                        console.log(JSON.stringify(e));
                        alert('메뉴를 불러오는 데 실패했습니다.');
                    }
                });
            }
        });

        // FullCalendar 초기화
        var calendarEl = document.getElementById('calendar');

        var calendar = new FullCalendar.Calendar(calendarEl, {
            plugins: ['interaction', 'dayGrid'],
            initialView: 'dayGridMonth',
            locale: 'ko',
            editable: true,
            eventLimit: true,
            dateClick: function(info) { // 날짜 클릭 이벤트 핸들러 수정
                // 클릭한 날짜 얻기
                selectedDate = info.dateStr; // 'YYYY-MM-DD' 형식
                console.log('Clicked Date:', selectedDate);

                // 기존의 가게 입력 폼 표시
                $('#storeForm').show();
                $('#menuContainer').hide();
            },
            events: [ // 초기 이벤트 데이터
                {
                    title: 'All Day Event',
                    start: '2024-09-01'
                },
                {
                    title: 'Long Event',
                    start: '2024-09-07',
                    end: '2024-09-10'
                },
                {
                    groupId: 999,
                    title: 'Repeating Event',
                    start: '2024-09-09T16:00:00'
                },
                {
                    groupId: 999,
                    title: 'Repeating Event',
                    start: '2024-09-16T16:00:00'
                },
                {
                    title: 'Conference',
                    start: '2024-09-11',
                    end: '2024-09-13'
                },
                {
                    title: 'Meeting',
                    start: '2024-09-12T10:30:00',
                    end: '2024-09-12T12:30:00'
                },
                {
                    title: 'Lunch',
                    start: '2024-09-12T12:00:00'
                },
                {
                    title: 'Meeting',
                    start: '2024-09-12T14:30:00'
                },
                {
                    title: 'Happy Hour',
                    start: '2024-09-12T17:30:00'
                },
                {
                    title: 'Dinner',
                    start: '2024-09-12T20:00:00'
                },
                {
                    title: 'Birthday Party',
                    start: '2024-09-13T07:00:00'
                },
                {
                    title: 'Click for Google',
                    url: 'http://google.com/',
                    start: '2024-09-28'
                }
            ]
        });

        calendar.render();

        // 초기 로드 시 식사 기록 불러오기 및 예산 불러오기
        loadDiningHistory(calendar);
        loadMonthlyBudget();
    });
</script>
</body>
</html>
