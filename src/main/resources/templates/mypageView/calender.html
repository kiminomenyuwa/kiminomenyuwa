<!DOCTYPE html>
<html lang="ko" xmlns:th="http://thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>식사 기록 캘린더</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }

        table, th, td {
            border: 1px solid black;
        }

        td {
            height: 100px;
            text-align: center;
            vertical-align: top;
        }

        .selected-date {
            background-color: #f0f8ff;
        }

        #calendar-controls {
            margin-bottom: 10px;
        }
    </style>

    <script>
        $(document).ready(function () {
            let currentDate = new Date(); // 현재 날짜
            let selectedDate = null;
            let selectedMenuId = null;
            let monthlyBudget = 0;  // 설정된 예산
            let totalSpent = 0;     // 총 소비 금액

            // 달력을 그리는 함수
            function drawCalendar(year, month) {
                const calendarBody = $('#calendar tbody');
                calendarBody.empty(); // 기존 날짜 지우기

                const firstDay = new Date(year, month, 1).getDay(); // 첫 번째 날짜의 요일
                const lastDate = new Date(year, month + 1, 0).getDate(); // 그 달의 마지막 날

                let dayCount = 1;
                let row = $('<tr></tr>');

                // 빈칸 추가 (첫 날 전까지)
                for (let i = 0; i < firstDay; i++) {
                    row.append('<td></td>');
                }

                // 날짜 추가
                for (let i = firstDay; i < 7; i++) {
                    row.append(`<td data-day="${dayCount}">${dayCount}</td>`);
                    dayCount++;
                }
                calendarBody.append(row);

                while (dayCount <= lastDate) {
                    row = $('<tr></tr>');
                    for (let i = 0; i < 7; i++) {
                        if (dayCount <= lastDate) {
                            row.append(`<td data-day="${dayCount}">${dayCount}</td>`);
                            dayCount++;
                        } else {
                            row.append('<td></td>'); // 남은 빈칸 추가
                        }
                    }
                    calendarBody.append(row);
                }

                // 현재 월 표시
                $('#currentMonth').text(`${year}년 ${month + 1}월`);
            }

            // 예산을 저장하는 함수
            function saveMonthlyBudget() {
                const currentUserId = '[[${#authentication.name}]]';
                $.ajax({
                    url: `api/budget?userId=${currentUserId}&budget=${monthlyBudget}`, // URL 파라미터로 전달
                    method: 'POST',
                    success: function () {
                        alert('예산이 저장되었습니다.');
                        updateRemainingBudget(); // 남은 예산 업데이트
                    },
                    error: function (e) {
                        console.log(JSON.stringify(e));
                        alert('예산 저장에 실패했습니다.');
                    }
                });
            }

            // 예산 설정 버튼 클릭 시 예산을 설정하고 저장
            $('#setBudgetButton').on('click', function () {
                monthlyBudget = parseInt($('#monthlyBudget').val()) || 0;  // 예산 설정
                saveMonthlyBudget(); // 예산 저장 호출
            });

            // 남은 예산을 계산하는 함수
            function updateRemainingBudget() {
                const remainingBudget = monthlyBudget - totalSpent;  // 남은 예산 = 예산 - 총 소비 금액
                $('#remainingBudget').text(remainingBudget);         // 남은 예산 표시
            }

            // 초기 로드 시 예산 불러오기
            function loadMonthlyBudget() {
                const currentUserId = '[[${#authentication.name}]]';
                $.ajax({
                    url: 'api/budget/remaining', // 예산 불러오기 API 엔드포인트
                    method: 'GET',
                    success: function (data) {
                        console.log('불러온 예산 데이터', data);
                        monthlyBudget = data.budget || 0; // 불러온 예산 설정
                        updateRemainingBudget(); // 남은 예산 업데이트
                    },
                    error: function (e) {
                        console.log(JSON.stringify(e));
                        console.error('예산을 불러오는 데 실패했습니다.');
                    }
                });
            }

            // 이전 달 버튼 클릭
            $('#prevMonthButton').on('click', function () {
                currentDate.setMonth(currentDate.getMonth() - 1); // 한 달 전으로
                drawCalendar(currentDate.getFullYear(), currentDate.getMonth());
                loadDiningHistory(); // 이전 달의 식사 기록 불러오기
                loadMonthlyBudget();
            });

            // 다음 달 버튼 클릭
            $('#nextMonthButton').on('click', function () {
                currentDate.setMonth(currentDate.getMonth() + 1); // 한 달 후로
                drawCalendar(currentDate.getFullYear(), currentDate.getMonth());
                loadDiningHistory(); // 다음 달의 식사 기록 불러오기
                loadMonthlyBudget();
            });

            // 초기 달력 그리기 (현재 월)
            drawCalendar(currentDate.getFullYear(), currentDate.getMonth());

            // 식사 기록 불러오기
            function loadDiningHistory() {
                const currentUserId = '[[${#authentication.name}]]';
                $.ajax({
                    url: 'api/dining-history',
                    method: 'GET',
                    success: function (data) {
                        console.log(data);
                        data.forEach(record => {
                            const diningDateArray = record.diningDate; // 배열로 전달된 날짜
                            const diningDate = new Date(
                                diningDateArray[0], diningDateArray[1] - 1, diningDateArray[2]
                            );
                            console.log(record.diningDate);
                            const day = diningDate.getDate();
                            const month = diningDate.getMonth(); // 월 정보 추가
                            const year = diningDate.getFullYear(); // 연도 정보 추가

                            // 메뉴 ID로 메뉴 이름을 가져오는 AJAX 호출
                            $.ajax({
                                url: `api/menus/${record.menuId}`,
                                method: 'GET',
                                success: function (menu) {
                                    const menuName = menu.name;  // 가져온 메뉴 이름
                                    const menuPrice = menu.price;   // 메뉴 가격 추가
                                    const cell = $(`td[data-day="${day}"]`);
                                    console.log(menu);

                                    if (cell.length) {
                                        // 해당 연도와 월에 맞는 셀을 찾아서 추가
                                        if (year === currentDate.getFullYear() && month === currentDate.getMonth()) {
                                            cell.append(`<div>${menuName}</div>`);  // 메뉴 이름을 셀에 추가
                                            totalSpent += menuPrice;  // 총 소비 금액 업데이트
                                            updateRemainingBudget();  // 남은 예산 업데이트
                                        }
                                    }
                                },
                                error: function () {
                                    console.error('Failed to fetch menu name for menuId:', record.menuId);
                                }
                            });
                        });
                    },
                    error: function (e) {
                        console.log(JSON.stringify(e));
                        alert('식사 기록을 불러오는 데 실패했습니다.');
                    }
                });
            }

            // 날짜 클릭 시 가게 입력 폼 표시
            $('#calendar').on('click', 'td', function () {
                if ($(this).text()) {
                    selectedDate = $(this).attr('data-day');
                    $('#storeForm').show();
                    $('#menuContainer').hide();
                    $('#calendar td').removeClass('selected-date');
                    $(this).addClass('selected-date');
                }
            });

            // 가게 이름 입력 후 확인 버튼 클릭 시 메뉴 가져오기
            $('#storeSubmitButton').on('click', function () {
                const storeName = $('#storeNameInput').val();
                if (storeName) {
                    // AJAX로 해당 가게의 메뉴 불러오기
                    $.ajax({
                        url: 'api/menus/store',
                        method: 'GET',
                        data: {storeName: storeName},
                        success: function (menus) {
                            $('#menuContainer').show();
                            $('#menuList').empty();
                            menus.forEach(menu => {
                                const menuItem = $('<div></div>').text(menu.name);
                                const selectButton = $('<button></button>').text('선택').on('click', function () {
                                    // 선택한 메뉴의 ID와 이름을 저장
                                    selectedMenuId = menu.menuId;

                                    // 선택한 메뉴의 이름을 사용하여 셀에 표시
                                    const selectedMenuName = menu.name;
                                    const selectedMenuPrice = menu.price;

                                    // 메뉴 가격도 추가
                                    saveDiningHistory(selectedMenuName, selectedMenuPrice); // 선택된 메뉴 이름으로 저장 호출
                                });
                                $('#menuList').append(menuItem).append(selectButton);
                            });
                        },
                        error: function (e) {
                            console.log(JSON.stringify(e));
                            alert('메뉴를 불러오는 데 실패했습니다.');
                        }
                    });
                }
            });

            // 식사 기록을 저장하는 함수
            function saveDiningHistory(selectedMenuName) {
                const menuId = selectedMenuId;  // 실제 선택된 메뉴 ID로 대체
                // 사용자가 선택한 날짜로 저장하도록 수정
                const diningDate = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}-${selectedDate.toString().padStart(2, '0')}T00:00:00`;
                const currentUserId = '[[${#authentication.name}]]';

                console.log(selectedDate);
                console.log(diningDate);

                $.ajax({
                    url: 'api/dining-history',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        userId: currentUserId,
                        menuId: menuId,
                        diningDate: diningDate // 수정된 부분
                    }),
                    success: function () {
                        alert('식사 기록이 저장되었습니다.');
                        // 선택한 날짜 셀에 메뉴 이름을 추가
                        const selectedCell = $(`td[data-day="${selectedDate}"]`);
                        selectedCell.append(`<div>${selectedMenuName}</div>`);

                        totalSpent += selectedMenuPrice;
                        updateRemainingBudget();

                    },
                    error: function () {
                        alert('식사 기록을 저장하는 데 실패했습니다.');
                        console.log(currentUserId);
                    }
                });
            }


            // 초기 로드 시 식사 기록 불러오기
            loadDiningHistory();
            loadMonthlyBudget();
        });
    </script>

</head>
<body>
<h1>식사 기록 캘린더</h1>

<!-- 예산 등록 및 남은 예산 표시 -->
<div id="budget-section" style="text-align: right; margin-bottom: 10px;">
    <label for="monthlyBudget">한 달 예산: </label>
    <input type="number" id="monthlyBudget" placeholder="예산을 입력하세요">
    <button id="setBudgetButton">예산 설정</button>
    <div>
        <span>남은 예산: </span><span id="remainingBudget">0</span>원
    </div>
</div>

<!-- 월 변경 버튼 -->
<div id="calendar-controls">
    <button id="prevMonthButton">이전 달</button>
    <span id="currentMonth"></span>
    <button id="nextMonthButton">다음 달</button>
</div>

<!-- 캘린더 테이블 -->
<table id="calendar">
    <!-- 헤더 -->
    <thead>
    <tr>
        <th>일</th>
        <th>월</th>
        <th>화</th>
        <th>수</th>
        <th>목</th>
        <th>금</th>
        <th>토</th>
    </tr>
    </thead>
    <!-- 날짜를 동적으로 추가 -->
    <tbody>
    <!-- 캘린더 날짜를 생성할 부분 -->
    </tbody>
</table>

<!-- 날짜를 클릭하면 가게 이름을 입력할 수 있는 폼 -->
<div id="storeForm" style="display: none;">
    <h2>가게 이름 입력</h2>
    <label for="storeNameInput">가게 이름:</label>
    <input type="text" id="storeNameInput" placeholder="가게 이름을 입력하세요">
    <button id="storeSubmitButton">확인</button>
</div>

<!-- 메뉴를 불러오는 부분 -->
<div id="menuContainer" style="display: none;">
    <h2>메뉴 목록</h2>
    <div id="menuList"></div>
</div>
</body>
</html>
