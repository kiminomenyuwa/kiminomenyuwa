<!DOCTYPE html>
<html lang="ko" xmlns:th="http://thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>식사 기록 캘린더</title>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        td {
            height: 100px;
            text-align: center;
            vertical-align: top;
        }
        .selected-date {
            background-color: #f0f8ff;
        }
        #calendar-controls {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<h1>식사 기록 캘린더</h1>

<!-- 월 변경 버튼 -->
<div id="calendar-controls">
    <button id="prevMonthButton">이전 달</button>
    <span id="currentMonth"></span>
    <button id="nextMonthButton">다음 달</button>
</div>

<!-- 캘린더 테이블 -->
<table id="calendar">
    <!-- 헤더 -->
    <thead>
    <tr>
        <th>일</th>
        <th>월</th>
        <th>화</th>
        <th>수</th>
        <th>목</th>
        <th>금</th>
        <th>토</th>
    </tr>
    </thead>
    <!-- 날짜를 동적으로 추가 -->
    <tbody>
    <!-- 캘린더 날짜를 생성할 부분 -->
    </tbody>
</table>

<!-- 날짜를 클릭하면 가게 이름을 입력할 수 있는 폼 -->
<div id="storeForm" style="display: none;">
    <h2>가게 이름 입력</h2>
    <label for="storeNameInput">가게 이름:</label>
    <input type="text" id="storeNameInput" placeholder="가게 이름을 입력하세요">
    <button id="storeSubmitButton">확인</button>
</div>

<!-- 메뉴를 불러오는 부분 -->
<div id="menuContainer" style="display: none;">
    <h2>메뉴 목록</h2>
    <div id="menuList"></div>
</div>

<script>
    $(document).ready(function() {
        let currentDate = new Date(); // 현재 날짜
        let selectedDate = null;
        let selectedMenuId = null;

        // 달력을 그리는 함수
        function drawCalendar(year, month) {
            const calendarBody = $('#calendar tbody');
            calendarBody.empty(); // 기존 날짜 지우기

            const firstDay = new Date(year, month, 1).getDay(); // 첫 번째 날짜의 요일
            const lastDate = new Date(year, month + 1, 0).getDate(); // 그 달의 마지막 날

            let dayCount = 1;
            let row = $('<tr></tr>');

            // 빈칸 추가 (첫 날 전까지)
            for (let i = 0; i < firstDay; i++) {
                row.append('<td></td>');
            }

            // 날짜 추가
            for (let i = firstDay; i < 7; i++) {
                row.append(`<td data-day="${dayCount}">${dayCount}</td>`);
                dayCount++;
            }
            calendarBody.append(row);

            while (dayCount <= lastDate) {
                row = $('<tr></tr>');
                for (let i = 0; i < 7; i++) {
                    if (dayCount <= lastDate) {
                        row.append(`<td data-day="${dayCount}">${dayCount}</td>`);
                        dayCount++;
                    } else {
                        row.append('<td></td>'); // 남은 빈칸 추가
                    }
                }
                calendarBody.append(row);
            }

            // 현재 월 표시
            $('#currentMonth').text(`${year}년 ${month + 1}월`);
        }

        // 이전 달 버튼 클릭
        $('#prevMonthButton').on('click', function() {
            currentDate.setMonth(currentDate.getMonth() - 1); // 한 달 전으로
            drawCalendar(currentDate.getFullYear(), currentDate.getMonth());
        });

        // 다음 달 버튼 클릭
        $('#nextMonthButton').on('click', function() {
            currentDate.setMonth(currentDate.getMonth() + 1); // 한 달 후로
            drawCalendar(currentDate.getFullYear(), currentDate.getMonth());
        });

        // 초기 달력 그리기 (현재 월)
        drawCalendar(currentDate.getFullYear(), currentDate.getMonth());

        // 날짜 클릭 시 가게 입력 폼 표시
        $('#calendar').on('click', 'td', function() {
            if ($(this).text()) {
                selectedDate = $(this).attr('data-day');
                $('#storeForm').show();
                $('#menuContainer').hide();
                $('#calendar td').removeClass('selected-date');
                $(this).addClass('selected-date');
            }
        });

        // 가게 이름 입력 후 확인 버튼 클릭 시 메뉴 가져오기
        $('#storeSubmitButton').on('click', function() {
            const storeName = $('#storeNameInput').val();
            if (storeName) {
                // AJAX로 해당 가게의 메뉴 불러오기
                $.ajax({
                    url: 'api/menus/store',
                    method: 'GET',
                    data: { storeName: storeName },
                    success: function(menus) {
                        $('#menuContainer').show();
                        $('#menuList').empty();
                        menus.forEach(menu => {
                            const menuItem = $('<div></div>').text(menu.name + ' - ' + menu.price + '원');
                            const selectButton = $('<button></button>').text('선택').on('click', function() {
                                selectedMenuId = menu.menuId;
                                saveDiningHistory(); // 선택된 메뉴 ID로 식사 기록 저장
                            });
                            $('#menuList').append(menuItem).append(selectButton);
                        });
                    },
                    error: function(e) {
                        console.log(JSON.stringify(e));
                        alert('메뉴를 불러오는 데 실패했습니다.');
                    }
                });
            }
        });

        // 식사 기록을 저장하는 함수
        function saveDiningHistory() {
            const currentUserId = /*[[${#authentication.principal.name}]]*/ '';
            console.log(currentUserId);
            const menuId = selectedMenuId;  // 실제 선택된 메뉴 ID로 대체
            const diningDate = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}-${selectedDate.toString().padStart(2, '0')}T00:00:00`;

            $.ajax({
                url: 'api/dining-history',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    userId: currentUserId,
                    menuId: menuId,
                    diningDate: diningDate
                }),
                success: function() {
                    alert('식사 기록이 저장되었습니다.');
                    // 선택한 날짜 셀에 메뉴 이름을 추가
                    const selectedCell = $(`td[data-day="${selectedDate}"]`);
                    selectedCell.append(`<div>${$('#menuList button:contains("선택")').prev().text()}</div>`);
                },
                error: function() {
                    alert('식사 기록을 저장하는 데 실패했습니다.');
                    console.log(currentUserId);
                }
            });
        }
    });
</script>
</body>
</html>
