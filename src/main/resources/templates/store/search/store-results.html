<!DOCTYPE html>
<html xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>상점 검색 결과</title>
    <meta charset="UTF-8">
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- 네이버 지도 API 스크립트 로드 -->
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=t06c4jgb48&submodules=geocoder"
            type="text/javascript"></script>
</head>
<body>
<div class="container mt-5">
    <h1>검색 결과</h1>
    <div class="mb-3">
        <a class="btn btn-secondary" href="/stores/search">다시 검색</a>
    </div>
    <div th:if="${#lists.isEmpty(stores)}">
        <p>검색 결과가 없습니다.</p>
    </div>
    <div th:unless="${#lists.isEmpty(stores)}">
        <table class="table table-striped">
            <thead>
            <tr>
                <th>상점 ID</th>
                <th>상점 이름</th>
                <th>카테고리</th>
                <th>주소</th>
                <th>전화번호</th>
                <th>설명</th>
                <th>위치 (경도, 위도)</th>
                <th>찜</th>
                <th>상세 보기</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="store : ${stores}">
                <td th:text="${store.storeId}">1</td>
                <td th:text="${store.name}">상점 이름</td>
                <td th:text="${store.category}">카테고리</td>
                <td th:text="${store.roadNameAddress} + ', ' + ${store.detailAddress} + ', ' + ${store.zipcode}">주소</td>
                <td th:text="${store.phoneNumber}">전화번호</td>
                <td th:text="${store.description}">설명</td>
                <td th:text="${store.longitude} + ', ' + ${store.latitude}">126.9855771, 37.5728571</td>
                <td>
                    <!-- 찜 버튼: 인증된 사용자에게만 표시 -->
                    <th:block sec:authorize="isAuthenticated()">
                        <button class="btn btn-outline-primary favorite-btn"
                                th:data-favorited="${store.favorited}"
                                th:data-store-id="${store.storeId}"
                                type="button">
                            <span th:text="${store.favorited} ? '찜 취소' : '찜 하기'">찜 하기</span>
                        </button>
                    </th:block>
                </td>
                <td>
                    <!-- 상세 보기 버튼 -->
                    <button class="btn btn-primary" data-target="#storeModal"
                            data-toggle="modal"
                            th:data-category="${store.category}"
                            th:data-certification="${store.certification}"
                            th:data-name="${store.name}"
                            th:data-description="${store.description}"
                            th:data-road-name-address="${store.roadNameAddress}"
                            th:data-detail-address="${store.detailAddress}"
                            th:data-zipcode="${store.zipcode}"
                            th:data-latitude="${store.latitude}"
                            th:data-longitude="${store.longitude}"
                            th:data-phone-number="${store.phoneNumber}"
                            th:data-store-id="${store.storeId}"
                            type="button">
                        상세 보기
                    </button>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- 모달 창 템플릿 -->
<div aria-hidden="true" aria-labelledby="storeModalLabel" class="modal fade" id="storeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="storeModalLabel">상점 상세 정보</h5>
                <button aria-label="닫기" class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- 상점 정보 -->
                <h3 id="modalStoreName"></h3>
                <p><strong>상점 ID:</strong> <span id="modalStoreId"></span></p>
                <p><strong>카테고리:</strong> <span id="modalCategory"></span></p>
                <p><strong>인증 정보:</strong> <span id="modalCertification"></span></p>
                <p><strong>주소:</strong> <span id="modalAddress"></span></p>
                <p><strong>전화번호:</strong> <span id="modalPhoneNumber"></span></p>
                <p><strong>설명:</strong> <span id="modalDescription"></span></p>
                <!-- 네이버 지도 -->
                <div id="map" style="width:100%; height:400px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal" type="button">닫기</button>
            </div>
        </div>
    </div>
</div>

<!-- jQuery, Popper.js, Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

<!-- 네이버 지도 API -->
<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=YOUR_NCP_CLIENT_ID&submodules=geocoder"
        type="text/javascript"></script>

<!-- 커스텀 JavaScript -->
<script type="text/javascript">
    $(document).ready(function () {
        // 찜 버튼 클릭 이벤트
        $('.favorite-btn').click(function () {
            var button = $(this);
            var storeId = button.data('store-id');
            var favorited = button.data('favorited');

            if (favorited) {
                // 찜 취소
                $.ajax({
                    url: '/api/favorites/' + storeId,
                    type: 'DELETE',
                    success: function (response) {
                        alert(response);
                        button.data('favorited', false);
                        button.html('<span>찜 하기</span>');
                    },
                    error: function (xhr) {
                        alert(xhr.responseText);
                    }
                });
            } else {
                // 찜 추가
                $.ajax({
                    url: '/api/favorites/' + storeId,
                    type: 'POST',
                    success: function (response) {
                        alert(response);
                        button.data('favorited', true);
                        button.html('<span>찜 취소</span>');
                    },
                    error: function (xhr) {
                        alert(xhr.responseText);
                    }
                });
            }
        });

        // 모달 창이 열릴 때 상점 정보 및 지도 초기화
        $('#storeModal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget); // 버튼 요소
            var storeId = button.data('store-id');
            var name = button.data('name');
            var certification = button.data('certification');
            var roadNameAddress = button.data('road-name-address');
            var detailAddress = button.data('detail-address');
            var zipcode = button.data('zipcode');
            var phoneNumber = button.data('phone-number');
            var category = button.data('category');
            var description = button.data('description');
            var longitude = button.data('longitude');
            var latitude = button.data('latitude');

            // 모달 요소 가져오기
            var modal = $(this);
            modal.find('#modalStoreName').text(name);
            modal.find('#modalStoreId').text(storeId);
            modal.find('#modalCategory').text(category);
            modal.find('#modalCertification').text(certification);
            modal.find('#modalAddress').text(roadNameAddress + ', ' + detailAddress + ', ' + zipcode);
            modal.find('#modalPhoneNumber').text(phoneNumber);
            modal.find('#modalDescription').text(description);

            // 네이버 지도 초기화
            var map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(latitude, longitude),
                zoom: 16
            });

            // 마커 추가
            var marker = new naver.maps.Marker({
                position: new naver.maps.LatLng(latitude, longitude),
                map: map
            });

            // 지도 중심 변경 (필요 시)
            map.setCenter(new naver.maps.LatLng(latitude, longitude));
        });

        // 모달이 닫힐 때 지도 초기화 (지도 리소스 해제)
        $('#storeModal').on('hidden.bs.modal', function () {
            $('#map').empty();
        });
    });
</script>
</body>
</html>
