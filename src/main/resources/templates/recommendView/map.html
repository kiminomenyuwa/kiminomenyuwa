<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>내 위치</title>
    <!-- Slick Slider CSS -->
    <link href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" rel="stylesheet" type="text/css"/>
    <!-- Slick Slider Theme CSS -->
    <link href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css" rel="stylesheet"
          type="text/css"/>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Naver Map API Script -->
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=t06c4jgb48&submodules=geocoder"
            type="text/javascript"></script>

    <style>
        body {
            padding-top: 70px;
        }

        .store-photo, .menu-photo {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: bold;
        }

        .badge-category {
            margin-right: 5px;
        }

        /* Slick Slider 커스터마이징 */
        .slick-slide {
            padding: 0 10px;
        }

        .slick-prev:before, .slick-next:before {
            color: #000;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h1>내 위치</h1>
    <div id="coordinates">Latitude: 37.5665, Longitude: 126.9780</div>
    <div id="map" style="width: 100%; height: 500px;"></div>

    <!-- 추천 메뉴 목록 -->
    <h3>추천 메뉴 목록</h3>
    <div class="menu-slider">
        <!-- 메뉴 카드가 여기서 동적으로 추가됩니다 -->
    </div>

    <!-- 메뉴 슬라이더 네비게이션 버튼 -->
    <div class="d-flex justify-content-center mt-3">
        <button class="btn btn-secondary mr-2 slick-prev-menu">이전</button>
        <button class="btn btn-secondary slick-next-menu">다음</button>
    </div>

    <!-- 주변 가게 목록 -->
    <h3 class="mt-5">주변 가게 목록</h3>
    <div class="row" id="store-list">
        <!-- 가게 카드가 여기서 동적으로 추가됩니다 -->
    </div>
</div>

<!-- jQuery, Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        let map;
        let userMarker;
        let storeMarkers = [];

        // 추천 이유에 따른 이모티콘 매핑
        const recommendationEmojiMap = {
            "사용자가 선호하는 카테고리": "❤",
            "유사한 사용자들이 선호하는 음식": "👨‍👩‍👧‍👦",
            "사용자가 선호하는 음식": "❤",
        };

        // Slick Slider 초기화 함수
        function initializeSlickSliders() {
            // 추천 메뉴 슬라이더 초기화
            $('.menu-slider').slick({
                slidesToShow: 3, // 한 번에 3개씩 표시
                slidesToScroll: 3, // 슬라이드 시 3개씩 이동
                infinite: false,
                dots: true, // 페이지네이션 활성화
                arrows: false,
                speed: 500, // 슬라이드 전환 속도 (밀리초)
                cssEase: 'ease-in-out', // 슬라이드 전환 애니메이션
                responsive: [
                    {
                        breakpoint: 1200,
                        settings: {
                            slidesToShow: 3,
                            slidesToScroll: 3
                        }
                    },
                    {
                        breakpoint: 992,
                        settings: {
                            slidesToShow: 2,
                            slidesToScroll: 2
                        }
                    },
                    {
                        breakpoint: 576,
                        settings: {
                            slidesToShow: 1,
                            slidesToScroll: 1
                        }
                    }
                ]
            });
        }

        // Slick Slider 네비게이션 버튼 설정
        function setSlickNavigation() {
            // 추천 메뉴 네비게이션
            $('.slick-prev-menu').click(function () {
                $('.menu-slider').slick('slickPrev');
            });
            $('.slick-next-menu').click(function () {
                $('.menu-slider').slick('slickNext');
            });
        }

        // 초기 Slick Slider 및 네비게이션 설정
        initializeSlickSliders();
        setSlickNavigation();

        // 초기 페이지 설정
        let menuCurrentPage = 0;
        let menuPageSize = 3; // 한 슬라이드당 3개씩 표시

        // Check if Geolocation is supported
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            alert("Geolocation은 이 브라우저에서 지원되지 않습니다.");
        }

        // Show current position on map
        function showPosition(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;

            // Initialize Naver Map
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(latitude, longitude),
                zoom: 15
            });

            // Add current location marker
            userMarker = new naver.maps.Marker({
                position: new naver.maps.LatLng(latitude, longitude),
                map: map,
                title: "내 위치"
            });

            // Fetch recommended menus and nearby stores based on current location
            fetchRecommendedMenus(latitude, longitude);

            // Add listener for map center change
            naver.maps.Event.addListener(map, 'dragend', function () {
                const newCenter = map.getCenter();
                let coordinatesDisplay = document.getElementById('coordinates');
                coordinatesDisplay.textContent = `Latitude: ${newCenter.lat()}, Longitude: ${newCenter.lng()}`;
                fetchRecommendedMenus(newCenter.lat(), newCenter.lng());
            });
        }

        // Error handler for Geolocation
        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    alert("위치 정보를 허용하지 않았습니다.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("위치 정보를 사용할 수 없습니다.");
                    break;
                case error.TIMEOUT:
                    alert("위치 정보를 가져오는 시간이 초과되었습니다.");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("알 수 없는 오류가 발생했습니다.");
                    break;
            }
        }

        // Function to fetch recommended menus and nearby stores from server
        function fetchRecommendedMenus(latitude, longitude) {
            $.ajax({
                url: '/recommendations/nearby-menus',
                type: 'POST',
                data: {
                    latitude: latitude,
                    longitude: longitude,
                    radius: 1000, // Example radius
                    limit: 10    // Number of recommendations to fetch
                },
                success: function (response) {
                    displayRecommendedMenus(response.recommendedMenus);
                    displayNearbyStores(response.nearbyStores);
                },
                error: function (xhr, status, error) {
                    alert("추천 메뉴 및 가게를 가져오는 중 오류가 발생했습니다.");
                }
            });
        }

        // Function to display recommended menus on the page
        function displayRecommendedMenus(menus) {
            const menuSlider = $('.menu-slider');
            // 슬라이더가 이미 초기화되었는지 확인
            if (menuSlider.hasClass('slick-initialized')) {
                menuSlider.slick('unslick'); // 슬라이더 파괴
            }

            menuSlider.empty(); // 기존 슬라이드 제거

            if (menus.length === 0) {
                menuSlider.append('<div><p class="text-muted">추천 메뉴가 없습니다.</p></div>');
                return;
            }

            menus.forEach(function (menu) {
                const menuCard = `
                        <div>
                            <div class="card h-100">
                                <img src="${menu.pictureUrl || '/images/default-menu.png'}" class="card-img-top menu-photo" alt="${menu.name}">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">${menu.name}</h5>
                                    <p class="card-text"><strong>가격:</strong> ${menu.price}원</p>
                                    <p class="card-text"><strong>카테고리:</strong> ${formatCategories(menu.categories)}</p>
                                     <p class="card-text"><em>${formatRecommendationReasons(menu.recommendationReasons)}</em></p> <!-- 추천 이유 표시 -->
                                    <a href="/menu/${menu.menuId}" class="btn btn-primary mt-auto">자세히 보기</a>
                                </div>
                            </div>
                        </div>
                    `;
                menuSlider.append(menuCard);
            });

            // 슬라이더 다시 초기화
            initializeSlickSliders();
            setSlickNavigation();
        }

        function formatRecommendationReasons(reasons) {
            if (!reasons || reasons.length === 0) return '';
            return reasons.map(reason => {
                const emoji = recommendationEmojiMap[reason] || ''; // 매핑된 이모티콘 또는 빈 문자열
                return `${emoji} ${reason}`;
            }).join(' & ');
        }

        // Function to format categories into badges
        function formatCategories(categories) {
            if (!categories || categories.length === 0) return '없음';
            return categories.map(category => `<span class="badge badge-secondary badge-category">${category.categoryName}</span>`).join(' ');
        }

        // Function to display nearby stores on the page and add markers to the map
        function displayNearbyStores(stores) {
            const storeList = $('#store-list');
            storeList.empty(); // Clear previous stores

            // Remove existing markers from the map
            storeMarkers.forEach(marker => marker.setMap(null));
            storeMarkers = [];

            stores.forEach(function (store) {
                const storeCard = `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <img src="${store.photoUrls && store.photoUrls.length > 0 ? store.photoUrls[0] : '/images/default-store.png'}" class="card-img-top store-photo" alt="${store.name}">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${store.name}</h5>
                                <p class="card-text"><strong>카테고리:</strong> ${store.category}</p>
                                <p class="card-text"><strong>전화번호:</strong> ${store.phoneNumber}</p>
                                <a href="/stores/${store.storeId}" class="btn btn-primary mt-auto">가게 보기</a>
                            </div>
                        </div>
                    </div>
                `;
                storeList.append(storeCard);

                // Add marker for each store
                const storeMarker = new naver.maps.Marker({
                    position: new naver.maps.LatLng(store.latitude, store.longitude),
                    map: map,
                    title: store.name
                });

                storeMarkers.push(storeMarker);
            });
        }
    });
</script>
<!-- Slick Slider JS -->
<script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js" type="text/javascript"></script>

</body>
</html>
