<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>ë‚´ ìœ„ì¹˜</title>
    <!-- Slick Slider CSS -->
    <link href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" rel="stylesheet" type="text/css"/>
    <!-- Slick Slider Theme CSS -->
    <link href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css" rel="stylesheet"
          type="text/css"/>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Naver Map API Script -->
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=t06c4jgb48&submodules=geocoder"
            type="text/javascript"></script>

    <style>
        body {
            padding-top: 70px;
        }

        .store-photo, .menu-photo {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: bold;
        }

        .badge-category {
            margin-right: 5px;
        }

        /* Slick Slider ì»¤ìŠ¤í„°ë§ˆì´ì§• */
        .slick-slide {
            padding: 0 10px;
        }

        .slick-prev:before, .slick-next:before {
            color: #000;
        }

        /* ìŠ¤ìœ„ì¹˜ ìŠ¤íƒ€ì¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #66bb6a;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h1>ë‚´ ìœ„ì¹˜</h1>
    <div id="coordinates">Latitude: 37.5665, Longitude: 126.9780</div>
    <div id="map" style="width: 100%; height: 500px;"></div>

    <!-- ì¶”ì²œ ë©”ë‰´ ëª©ë¡ -->
    <h3>ì¶”ì²œ ë©”ë‰´ ëª©ë¡</h3>
    <div class="menu-slider">
        <!-- ë©”ë‰´ ì¹´ë“œê°€ ì—¬ê¸°ì„œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>

    <!-- ë©”ë‰´ ìŠ¬ë¼ì´ë” ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
    <div class="d-flex justify-content-center mt-3">
        <button class="btn btn-secondary mr-2 slick-prev-menu">ì´ì „</button>
        <button class="btn btn-secondary slick-next-menu">ë‹¤ìŒ</button>
    </div>

    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ì‹œì‘ -->
    <ul class="nav nav-tabs mt-5" id="storeTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" id="nearby-stores-tab" data-toggle="tab" href="#nearby-stores" role="tab"
               aria-controls="nearby-stores" aria-selected="true">ì£¼ë³€ ê°€ê²Œ ëª©ë¡</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="minigame-recommendations-tab" data-toggle="tab"
               href="#minigame-recommendations-tab-content" role="tab"
               aria-controls="minigame-recommendations-tab-content" aria-selected="false">ë¯¸ë‹ˆê²Œì„ ê¸°ë°˜ ì¶”ì²œ ëª©ë¡</a>
        </li>
    </ul>
    <!-- íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ë -->

    <!-- íƒ­ ì½˜í…ì¸  ì‹œì‘ -->
    <div class="tab-content" id="storeTabsContent">
        <!-- ì£¼ë³€ ê°€ê²Œ ëª©ë¡ íƒ­ -->
        <div class="tab-pane fade show active" id="nearby-stores" role="tabpanel" aria-labelledby="nearby-stores-tab">
            <h3 class="mt-3">ì£¼ë³€ ê°€ê²Œ ëª©ë¡</h3>
            <div class="row" id="store-list">
                <!-- ê°€ê²Œ ì¹´ë“œê°€ ì—¬ê¸°ì„œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ë¯¸ë‹ˆê²Œì„ ê¸°ë°˜ ì¶”ì²œ ëª©ë¡ íƒ­ -->
        <div class="tab-pane fade" id="minigame-recommendations-tab-content" role="tabpanel"
             aria-labelledby="minigame-recommendations-tab">
            <h3 class="mt-3">ë¯¸ë‹ˆê²Œì„ ê¸°ë°˜ ì¶”ì²œ ëª©ë¡</h3>
            <div class="budget-switch mb-3">
                <input type="checkbox" id="budget-toggle-minigame"/>
                <label for="budget-toggle-minigame">ì˜ˆì‚° ê³ ë ¤</label>
            </div>
            <div id="minigame-recommendations">
                <!-- ë¯¸ë‹ˆê²Œì„ ì¶”ì²œ ë©”ë‰´ ì¹´ë“œê°€ ì—¬ê¸°ì„œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>
    <!-- íƒ­ ì½˜í…ì¸  ë -->
</div>

<!-- jQuery, Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<!-- Slick Slider JS -->
<script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js" type="text/javascript"></script>

<script type="text/javascript">
    $(document).ready(function () {
        let map;
        let userMarker;
        let storeMarkers = [];

        // ì¶”ì²œ ì´ìœ ì— ë”°ë¥¸ ì´ëª¨í‹°ì½˜ ë§¤í•‘
        const recommendationEmojiMap = {
            "ì‚¬ìš©ìê°€ ì„ í˜¸í•˜ëŠ” ì¹´í…Œê³ ë¦¬": "â¤",
            "ìœ ì‚¬í•œ ì‚¬ìš©ìë“¤ì´ ì„ í˜¸í•˜ëŠ” ìŒì‹": "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦",
            "ì‚¬ìš©ìê°€ ì„ í˜¸í•˜ëŠ” ìŒì‹": "â¤",
        };

        // Slick Slider ì´ˆê¸°í™” í•¨ìˆ˜
        function initializeSlickSliders() {
            // ì¶”ì²œ ë©”ë‰´ ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
            $('.menu-slider').slick({
                slidesToShow: 3, // í•œ ë²ˆì— 3ê°œì”© í‘œì‹œ
                slidesToScroll: 3, // ìŠ¬ë¼ì´ë“œ ì‹œ 3ê°œì”© ì´ë™
                infinite: false,
                dots: true, // í˜ì´ì§€ë„¤ì´ì…˜ í™œì„±í™”
                arrows: false,
                speed: 500, // ìŠ¬ë¼ì´ë“œ ì „í™˜ ì†ë„ (ë°€ë¦¬ì´ˆ)
                cssEase: 'ease-in-out', // ìŠ¬ë¼ì´ë“œ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜
                responsive: [
                    {
                        breakpoint: 1200,
                        settings: {
                            slidesToShow: 3,
                            slidesToScroll: 3
                        }
                    },
                    {
                        breakpoint: 992,
                        settings: {
                            slidesToShow: 2,
                            slidesToScroll: 2
                        }
                    },
                    {
                        breakpoint: 576,
                        settings: {
                            slidesToShow: 1,
                            slidesToScroll: 1
                        }
                    }
                ]
            });
        }

        // Slick Slider ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì„¤ì •
        function setSlickNavigation() {
            // ì¶”ì²œ ë©”ë‰´ ë„¤ë¹„ê²Œì´ì…˜
            $('.slick-prev-menu').click(function () {
                $('.menu-slider').slick('slickPrev');
            });
            $('.slick-next-menu').click(function () {
                $('.menu-slider').slick('slickNext');
            });
        }

        // ì´ˆê¸° Slick Slider ë° ë„¤ë¹„ê²Œì´ì…˜ ì„¤ì •
        initializeSlickSliders();
        setSlickNavigation();

        // ì´ˆê¸° í˜ì´ì§€ ì„¤ì •
        let menuCurrentPage = 0;
        let menuPageSize = 3; // í•œ ìŠ¬ë¼ì´ë“œë‹¹ 3ê°œì”© í‘œì‹œ

        // Check if Geolocation is supported
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            alert("Geolocationì€ ì´ ë¸Œë¼ìš°ì €ì—ì„œ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }

        // ìŠ¤ìœ„ì¹˜ ìƒíƒœ ë³€ê²½ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
        $('#budget-toggle-minigame').change(function () {
            const isChecked = $(this).is(':checked');
            console.log('Budget toggle switched:', isChecked); // ìŠ¤ìœ„ì¹˜ ìƒíƒœ í™•ì¸

            // í˜„ì¬ ì§€ë„ ìœ„ì¹˜ì˜ ìœ„ë„ì™€ ê²½ë„ ê°€ì ¸ì˜¤ê¸°
            if (map) {
                const latitude = map.getCenter().lat();
                const longitude = map.getCenter().lng();
                fetchMinigameRecommendations(latitude, longitude, isChecked);
            }
        });

        // Show current position on map
        function showPosition(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;

            // Initialize Naver Map
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(latitude, longitude),
                zoom: 15
            });

            // Add current location marker
            userMarker = new naver.maps.Marker({
                position: new naver.maps.LatLng(latitude, longitude),
                map: map,
                title: "ë‚´ ìœ„ì¹˜"
            });

            // Fetch recommended menus and nearby stores based on current location
            const isBudgetMinigame = $('#budget-toggle-minigame').is(':checked'); // ìŠ¤ìœ„ì¹˜ ìƒíƒœ í™•ì¸
            console.log('Budget toggle status at initial fetch:', isBudgetMinigame);
            fetchRecommendedMenus(latitude, longitude);
            fetchMinigameRecommendations(latitude, longitude, isBudgetMinigame);

            // Add listener for map center change
            naver.maps.Event.addListener(map, 'dragend', function () {
                const newCenter = map.getCenter();
                let coordinatesDisplay = document.getElementById('coordinates');
                coordinatesDisplay.textContent = `Latitude: ${newCenter.lat()}, Longitude: ${newCenter.lng()}`;

                // Fetch menus and recommendations based on updated map location and switch state
                const updatedIsBudgetMinigame = $('#budget-toggle-minigame').is(':checked');
                console.log('Budget toggle status after map drag:', updatedIsBudgetMinigame);
                fetchRecommendedMenus(newCenter.lat(), newCenter.lng());
                fetchMinigameRecommendations(newCenter.lat(), newCenter.lng(), updatedIsBudgetMinigame);
            });
        }

        // Error handler for Geolocation
        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ í—ˆìš©í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    break;
                case error.TIMEOUT:
                    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    break;
            }
        }

        // Function to fetch recommended menus and nearby stores from server
        function fetchRecommendedMenus(latitude, longitude) {
            $.ajax({
                url: '/recommendations/nearby-menus',
                type: 'POST',
                data: {
                    latitude: latitude,
                    longitude: longitude,
                    radius: 1000, // Example radius
                    limit: 10    // Number of recommendations to fetch
                },
                success: function (response) {
                    displayRecommendedMenus(response.recommendedMenus);
                    displayNearbyStores(response.nearbyStores);
                },
                error: function (xhr, status, error) {
                    alert("ì¶”ì²œ ë©”ë‰´ ë° ê°€ê²Œë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            });
        }

        // Function to display recommended menus on the page
        function displayRecommendedMenus(menus) {
            const menuSlider = $('.menu-slider');
            // ìŠ¬ë¼ì´ë”ê°€ ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (menuSlider.hasClass('slick-initialized')) {
                menuSlider.slick('unslick'); // ìŠ¬ë¼ì´ë” íŒŒê´´
            }

            menuSlider.empty(); // ê¸°ì¡´ ìŠ¬ë¼ì´ë“œ ì œê±°

            if (menus.length === 0) {
                menuSlider.append('<div><p class="text-muted">ì¶”ì²œ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>');
                return;
            }

            menus.forEach(function (menu) {
                const menuCard = `
                        <div>
                            <div class="card h-100">
                                <img src="${menu.pictureUrl || '/images/default-menu.png'}" class="card-img-top menu-photo" alt="${menu.name}">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">${menu.name}</h5>
                                    <p class="card-text"><strong>ê°€ê²©:</strong> ${menu.price}ì›</p>
                                    <p class="card-text"><strong>ì¹´í…Œê³ ë¦¬:</strong> ${formatCategories(menu.categories)}</p>
                                    <p class="card-text"><em>${formatRecommendationReasons(menu.recommendationReasons)}</em></p> <!-- ì¶”ì²œ ì´ìœ  í‘œì‹œ -->
                                    <a href="/menu/${menu.menuId}" class="btn btn-primary mt-auto">ìì„¸íˆ ë³´ê¸°</a>
                                </div>
                            </div>
                        </div>
                    `;
                menuSlider.append(menuCard);
            });

            // ìŠ¬ë¼ì´ë” ë‹¤ì‹œ ì´ˆê¸°í™”
            initializeSlickSliders();
            setSlickNavigation();
        }

        function formatRecommendationReasons(reasons) {
            if (!reasons || reasons.length === 0) return '';
            return reasons.map(reason => {
                const emoji = recommendationEmojiMap[reason] || ''; // ë§¤í•‘ëœ ì´ëª¨í‹°ì½˜ ë˜ëŠ” ë¹ˆ ë¬¸ìì—´
                return `${emoji} ${reason}`;
            }).join(' & ');
        }

        // Function to format categories into badges
        function formatCategories(categories) {
            if (!categories || categories.length === 0) return 'ì—†ìŒ';
            return categories.map(category => `<span class="badge badge-secondary badge-category">${category.categoryName}</span>`).join(' ');
        }

        // Function to display nearby stores on the page and add markers to the map
        function displayNearbyStores(stores) {
            const storeList = $('#store-list');
            storeList.empty(); // Clear previous stores

            // Remove existing markers from the map
            storeMarkers.forEach(marker => marker.setMap(null));
            storeMarkers = [];

            stores.forEach(function (store) {
                const storeCard = `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <img src="${store.photoUrls && store.photoUrls.length > 0 ? store.photoUrls[0] : '/images/default-store.png'}" class="card-img-top store-photo" alt="${store.name}">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${store.name}</h5>
                                <p class="card-text"><strong>ì¹´í…Œê³ ë¦¬:</strong> ${store.category}</p>
                                <p class="card-text"><strong>ì „í™”ë²ˆí˜¸:</strong> ${store.phoneNumber}</p>
                                <a href="/stores/${store.storeId}" class="btn btn-primary mt-auto">ê°€ê²Œ ë³´ê¸°</a>
                            </div>
                        </div>
                    </div>
                `;
                storeList.append(storeCard);

                // Add marker for each store
                const storeMarker = new naver.maps.Marker({
                    position: new naver.maps.LatLng(store.latitude, store.longitude),
                    map: map,
                    title: store.name
                });

                storeMarkers.push(storeMarker);
            });
        }

        // ì„œë²„ë¡œë¶€í„° ë¯¸ë‹ˆê²Œì„ ê¸°ë°˜ ì¶”ì²œ ë©”ë‰´ ê°€ì ¸ì˜¤ê¸°
        function fetchMinigameRecommendations(latitude, longitude, budgetConsidered) {
            if (budgetConsidered) {
                // ì˜ˆì‚°ì„ ê³ ë ¤í•œ ë¯¸ë‹ˆê²Œì„ ì¶”ì²œ ë©”ë‰´ ê°€ì ¸ì˜¤ê¸°
                $.ajax({
                    url: '/recommendations/api/minigame/recommendations',
                    type: 'GET',
                    data: {
                        latitude: latitude,
                        longitude: longitude,
                        budgetConsidered: true
                    },
                    success: function (data) {
                        console.log('ë¯¸ë‹ˆê²Œì„ ì¶”ì²œ ì„±ê³µ:', data); // ì„±ê³µ ì‹œ ë°ì´í„° í™•ì¸
                        if (data.budgetSet) {
                            displayMinigameRecommendations(data.recommendedMenus);
                        } else {
                            alert(data.message);
                            // ì˜ˆì‚° ìŠ¤ìœ„ì¹˜ í•´ì œ
                            $('#budget-toggle-minigame').prop('checked', false);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log('ë¯¸ë‹ˆê²Œì„ ì¶”ì²œ ì‹¤íŒ¨:', error); // ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ í™•ì¸
                        alert("ë¯¸ë‹ˆê²Œì„ ê¸°ë°˜ ì¶”ì²œ ë©”ë‰´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            } else {
                // ì˜ˆì‚°ì„ ê³ ë ¤í•˜ì§€ ì•Šì€ ë¯¸ë‹ˆê²Œì„ ì¶”ì²œ ë©”ë‰´ ê°€ì ¸ì˜¤ê¸°
                $.ajax({
                    url: '/recommendations/api/minigame/recommendations',
                    type: 'GET',
                    data: {
                        latitude: latitude,
                        longitude: longitude,
                        budgetConsidered: false
                    },
                    success: function (data) {
                        console.log('ë¯¸ë‹ˆê²Œì„ ì¶”ì²œ ì„±ê³µ (ì˜ˆì‚° ë¯¸ê³ ë ¤):', data); // ì„±ê³µ ì‹œ ë°ì´í„° í™•ì¸
                        displayMinigameRecommendations(data.recommendedMenus);
                    },
                    error: function (xhr, status, error) {
                        console.log('ë¯¸ë‹ˆê²Œì„ ì¶”ì²œ ì‹¤íŒ¨ (ì˜ˆì‚° ë¯¸ê³ ë ¤):', error); // ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ í™•ì¸
                        alert("ë¯¸ë‹ˆê²Œì„ ê¸°ë°˜ ì¶”ì²œ ë©”ë‰´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            }
        }

        // ë¯¸ë‹ˆê²Œì„ ê¸°ë°˜ ì¶”ì²œ ë©”ë‰´ë¥¼ í˜ì´ì§€ì— í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function displayMinigameRecommendations(menus) {
            console.log('Displaying minigame recommendations:', menus);
            const minigameRecommendations = $('#minigame-recommendations');
            minigameRecommendations.empty(); // ì´ì „ ì¶”ì²œ ëª©ë¡ ì‚­ì œ

            if (menus.length === 0) {
                minigameRecommendations.append('<p class="text-muted">ë¯¸ë‹ˆê²Œì„ ê¸°ë°˜ ì¶”ì²œ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>');
                return;
            }

            let recommendedMenusHTML = `
                <div class="row">
            `;
            menus.forEach(menu => {
                recommendedMenusHTML += `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <img src="${menu.pictureUrl || '/images/default-menu.png'}" class="card-img-top menu-photo" alt="${menu.name}">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${menu.name}</h5>
                                <p class="card-text"><strong>ê°€ê²©:</strong> ${menu.price}ì›</p>
                                <p class="card-text"><strong>ì¹´í…Œê³ ë¦¬:</strong> ${formatCategories(menu.categories)}</p>
                                <a href="/menu/${menu.menuId}" class="btn btn-primary mt-auto">ìì„¸íˆ ë³´ê¸°</a>
                            </div>
                        </div>
                    </div>
                `;
            });
            recommendedMenusHTML += `
                </div>
            `;
            minigameRecommendations.append(recommendedMenusHTML);
        }
    });
</script>
</body>
</html>
