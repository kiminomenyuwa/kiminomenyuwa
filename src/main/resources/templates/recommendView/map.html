<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>내 위치</title>
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Naver Map API Script -->
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=t06c4jgb48&submodules=geocoder"
            type="text/javascript"></script>
</head>
<body>
<div class="container mt-5">
    <h1>내 위치</h1>
    <div id="coordinates">Latitude: 37.5665, Longitude: 126.9780</div>
    <div id="map" style="width: 100%; height: 500px;"></div>
    <h3>추천 메뉴 목록</h3>
    <ul class="list-group mt-3" id="menu-list"></ul>
    <h3>주변 가게 목록</h3>
    <ul class="list-group mt-3" id="store-list"></ul>
</div>

<!-- jQuery, Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        let map;
        let userMarker;
        let storeMarkers = [];

        // Check if Geolocation is supported
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            alert("Geolocation은 이 브라우저에서 지원되지 않습니다.");
        }

        // Show current position on map
        function showPosition(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;

            // Initialize Naver Map
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(latitude, longitude),
                zoom: 15
            });

            // Add current location marker
            userMarker = new naver.maps.Marker({
                position: new naver.maps.LatLng(latitude, longitude),
                map: map,
                title: "내 위치"
            });

            // Fetch recommended menus and nearby stores based on current location
            fetchRecommendedMenus(latitude, longitude);

            // Add listener for map center change
            naver.maps.Event.addListener(map, 'dragend', function () {
                const newCenter = map.getCenter();
                let coordinatesDisplay = document.getElementById('coordinates');
                coordinatesDisplay.textContent = `Latitude: ${newCenter.lat()}, Longitude: ${newCenter.lng()}`;
                fetchRecommendedMenus(newCenter.lat(), newCenter.lng());
            });
        }

        // Error handler for Geolocation
        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    alert("위치 정보를 허용하지 않았습니다.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("위치 정보를 사용할 수 없습니다.");
                    break;
                case error.TIMEOUT:
                    alert("위치 정보를 가져오는 시간이 초과되었습니다.");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("알 수 없는 오류가 발생했습니다.");
                    break;
            }
        }

        // Function to fetch recommended menus and nearby stores from server
        function fetchRecommendedMenus(latitude, longitude) {
            $.ajax({
                url: '/recommendations/nearby-menus',
                type: 'POST',
                data: {
                    latitude: latitude,
                    longitude: longitude,
                    radius: 1000, // Example radius
                    limit: 10    // Number of recommendations to fetch
                },
                success: function (response) {
                    displayRecommendedMenus(response.recommendedMenus);
                    displayNearbyStores(response.nearbyStores);
                },
                error: function (xhr, status, error) {
                    console.error("Error fetching recommended menus and stores: ", error);
                    alert("추천 메뉴 및 가게를 가져오는 중 오류가 발생했습니다.");
                }
            });
        }

        // Function to display recommended menus on the page
        function displayRecommendedMenus(menus) {
            const menuList = $('#menu-list');
            menuList.empty(); // Clear previous menus

            menus.forEach(function (menu) {
                const menuItem = $('<li class="list-group-item"></li>').text(menu.name + ' - ' + menu.price + '원');
                menuList.append(menuItem);
            });
        }

        // Function to display nearby stores on the page and add markers to the map
        function displayNearbyStores(stores) {
            const storeList = $('#store-list');
            storeList.empty(); // Clear previous stores

            // Remove existing markers from the map
            storeMarkers.forEach(marker => marker.setMap(null));
            storeMarkers = [];

            stores.forEach(function (store) {
                const storeItem = $('<li class="list-group-item"></li>').text(store.name + ' - ' + store.category);
                storeList.append(storeItem);

                // Add marker for each store
                const storeMarker = new naver.maps.Marker({
                    position: new naver.maps.LatLng(store.latitude, store.longitude),
                    map: map,
                    title: store.name
                });

                storeMarkers.push(storeMarker);
            });
        }
    });
</script>
</body>
</html>
