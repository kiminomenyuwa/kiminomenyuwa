<!DOCTYPE html>
<html xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>가게 등록</title>

    <!-- Naver Map API Script -->
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=t06c4jgb48&submodules=geocoder"
            type="text/javascript"></script>

    <script src="/js/jquery-3.7.1.min.js"></script>
    <!-- 카카오 도로명주소 서비스 호출 -->
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

    <script>
        $(document).ready(function () {
            //도로명주소 새창 팝업
            $('#searchAddressBtn').click(kakaoRoadAddress);
            //가게 등록 데이터 전송
            $('#submitForm').click(function () {
                let formData = new FormData($('#storeForm')[0]);
                // 추가 데이터 (enabled) 설정
                formData.append('enabled', true); // 기본적으로 가게는 활성화됨

                $.ajax({
                    url: '/merchant/stores/registration', // 절대 경로로 수정
                    type: 'post',
                    data: formData,
                    processData: false, // jQuery가 데이터를 처리하지 않도록 설정
                    contentType: false, // jQuery가 콘텐츠 타입을 설정하지 않도록 설정
                    success: function (response) {
                        alert('가게가 정상 등록되었습니다.');
                        // 성공하면 페이지 리다이렉트
                        window.location.href = response; // 반환된 URL로 리다이렉트
                    },
                    error: function (e) {
                        console.log(JSON.stringify(e));
                        $("#response").html("가게 등록에 실패했습니다: " + e.responseText);
                    }
                })
            })
        })

        //카카오 도로명주소 사용
        function kakaoRoadAddress() {
            new daum.Postcode({
                oncomplete: function (data) {
                    //카카오 도로명주소에서 받아온 data html에 반영

                    // 네이버 geocode로 주소 -> 좌표 변환
                    naver.maps.Service.geocode({
                        query: data.address
                    }, function (status, response) {
                        if (status !== naver.maps.Service.Status.OK) {
                            return alert('Something wrong!');
                        }
                        var result = response.v2, // 검색 결과의 컨테이너
                            items = result.addresses; // 검색 결과의 배열
                        $('#longitude').val(items[0].x);
                        $('#latitude').val(items[0].y);
                    });

                    $('#zipcode').val(data.zonecode);
                    $('#roadNameAddress').val(data.roadAddress);
                }
            }).open();
        }
    </script>
</head>
<body>
<!-- 네비게이션 바 -->
<nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="/merchant/stores">가게 관리</a>
        <button aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation" class="navbar-toggler"
                data-bs-target="#navbarNav" data-bs-toggle="collapse" type="button">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/merchant/stores">가게 목록</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/merchant/stores/registration">가게 등록</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/merchant/stores/registration">메뉴 등록</a>
                </li>
                <li class="nav-item">
                    <span class="nav-link">
                        로그인한 사장님: <strong th:text="${#authentication.principal.username}">사장님 이름</strong>
                    </span>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/user/logout">로그아웃</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-5 pt-5">
    <h1 class="mb-4">가게 등록</h1>
    <form enctype="multipart/form-data" id="storeForm">
        <div class="mb-3">
            <label class="form-label" for="name">가게 이름</label>
            <input class="form-control" id="name" name="name" required type="text">
        </div>
        <div class="mb-3">
            <label class="form-label" for="zipcode">우편번호</label>
            <div class="input-group">
                <input class="form-control" id="zipcode" name="zipcode" placeholder="주소 검색 기능 사용" readonly type="text">
                <button class="btn btn-outline-secondary" id="searchAddressBtn" type="button">주소검색</button>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label" for="roadNameAddress">도로명 주소</label>
            <input class="form-control" id="roadNameAddress" name="roadNameAddress" placeholder="주소 검색 기능 사용"
                   readonly type="text">
        </div>
        <div class="mb-3">
            <label class="form-label" for="detailAddress">상세 주소</label>
            <input class="form-control" id="detailAddress" name="detailAddress" type="text">
        </div>
        <div class="mb-3">
            <label class="form-label" for="phoneNumber">전화번호</label>
            <input class="form-control" id="phoneNumber" name="phoneNumber" type="text">
        </div>
        <div class="mb-3">
            <label class="form-label" for="category">카테고리</label>
            <input class="form-control" id="category" name="category" type="text">
        </div>
        <div class="mb-3">
            <label class="form-label" for="description">설명</label>
            <textarea class="form-control" id="description" name="description"></textarea>
        </div>
        <div class="mb-3">
            <label class="form-label" for="photos">사진 업로드</label>
            <input accept="image/*" class="form-control" id="photos" multiple name="photos" type="file">
            <div class="form-text">여러 장의 사진을 선택할 수 있습니다.</div>
        </div>
        <input type="hidden" id="longitude" name="longitude" th:value="127.000">
        <input type="hidden" id="latitude" name="latitude" th:value="37.000">
        <div class="d-grid">
            <button class="btn btn-primary" id="submitForm" type="button">등록</button>
        </div>
    </form>
    <p class="mt-3 text-danger" id="response"></p>
</div>

<!-- Bootstrap JS Bundle (Popper 포함) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>