<!-- src/main/resources/templates/merchant/storeRegistration.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>가게 등록</title>

    <!-- Naver Map API Script -->
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=t06c4jgb48&submodules=geocoder"
            type="text/javascript"></script>

    <!-- 부트스트랩 CSS 추가 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/.bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- jQuery -->
    <script src="/js/jquery-3.7.1.min.js"></script>

    <!-- 카카오 도로명주소 서비스 호출 -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>

    <script>
        $(document).ready(function () {
            // 도로명주소 새창 팝업
            $('#searchAddressBtn').click(kakaoRoadAddress);
            // 가게 등록 데이터 전송
            $('#submitForm').click(function () {
                let formData = new FormData($('#storeForm')[0]);
                // 추가 데이터 (enabled) 설정
                formData.append('enabled', true); // 기본적으로 가게는 활성화됨

                $.ajax({
                    url: '/merchant/stores/registration', // 절대 경로로 수정
                    type: 'post',
                    data: formData,
                    processData: false, // jQuery가 데이터를 처리하지 않도록 설정
                    contentType: false, // jQuery가 콘텐츠 타입을 설정하지 않도록 설정
                    success: function (response) {
                        alert('가게가 정상 등록되었습니다.');
                        // 성공하면 페이지 리다이렉트
                        window.location.href = response; // 반환된 URL로 리다이렉트
                    },
                    error: function (e) {
                        console.log(JSON.stringify(e));
                        $("#response").html("가게 등록에 실패했습니다: " + e.responseText);
                    }
                })
            })
        });

        // 카카오 도로명주소 사용
        function kakaoRoadAddress() {
            new daum.Postcode({
                oncomplete: function (data) {
                    //카카오 도로명주소에서 받아온 data html에 반영

                    // 네이버 geocode로 주소 -> 좌표 변환
                    naver.maps.Service.geocode({
                        query: data.address
                    }, function (status, response) {
                        if (status !== naver.maps.Service.Status.OK) {
                            return alert('Something wrong!');
                        }
                        var result = response.v2, // 검색 결과의 컨테이너
                            items = result.addresses; // 검색 결과의 배열
                        $('#longitude').val(items[0].x);
                        $('#latitude').val(items[0].y);
                    });

                    // 카카오 도로명주소에서 받아온 data html에 반영
                    $('#zipcode').val(data.zonecode);
                    $('#roadNameAddress').val(data.roadAddress);
                }
            }).open();
        }
    </script>

    <style>
        /* 테이블 행 클릭 시 포인터 변경 */
        .clickable-row {
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h1 class="mb-4 text-center">가게 등록</h1>
    <form enctype="multipart/form-data" id="storeForm">
        <div class="mb-3 row">
            <label for="name" class="col-sm-2 col-form-label">가게 이름:</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="name" name="name" required>
            </div>
        </div>
        <div class="mb-3 row">
            <label for="certification" class="col-sm-2 col-form-label">인증 정보:</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="certification" name="certification" required>
            </div>
        </div>
        <div class="mb-3 row">
            <label for="zipcode" class="col-sm-2 col-form-label">우편번호:</label>
            <div class="col-sm-8">
                <input type="text" class="form-control" id="zipcode" name="zipcode" readonly
                       placeholder="주소 검색 기능 사용">
            </div>
            <div class="col-sm-2">
                <button type="button" class="btn btn-primary w-100" id="searchAddressBtn">주소검색</button>
            </div>
        </div>
        <div class="mb-3 row">
            <label for="roadNameAddress" class="col-sm-2 col-form-label">도로명 주소:</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="roadNameAddress" name="roadNameAddress" readonly
                       placeholder="주소 검색 기능 사용">
            </div>
        </div>
        <div class="mb-3 row">
            <label for="detailAddress" class="col-sm-2 col-form-label">상세 주소:</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="detailAddress" name="detailAddress">
            </div>
        </div>
        <div class="mb-3 row">
            <label for="phoneNumber" class="col-sm-2 col-form-label">전화번호:</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="phoneNumber" name="phoneNumber">
            </div>
        </div>
        <div class="mb-3 row">
            <label for="category" class="col-sm-2 col-form-label">카테고리:</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="category" name="category">
            </div>
        </div>
        <div class="mb-3 row">
            <label for="description" class="col-sm-2 col-form-label">설명:</label>
            <div class="col-sm-10">
                <textarea class="form-control" id="description" name="description" rows="3"></textarea>
            </div>
        </div>
        <!-- 사진 업로드 필드 추가 -->
        <tr>
            <td><label for="photos">사진 업로드:</label></td>
            <td>
                <input accept="image/*" id="photos" multiple name="photos" type="file">
                <small>여러 장의 사진을 선택할 수 있습니다.</small>
            </td>
        </tr>
        <input type="hidden" id="longitude" name="longitude" th:value="127.000">
        <input type="hidden" id="latitude" name="latitude" th:value="37.000">
        <tr>
            <td colspan="2">
                <button id="submitForm" type="button">등록</button>
            </td>
        </tr>
        </table>
    </form>

    <p id="response" class="mt-3 text-center text-danger"></p>
</div>
</body>
</html>
