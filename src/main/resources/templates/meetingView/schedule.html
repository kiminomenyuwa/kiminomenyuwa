<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>ë‹¤ì¤‘ ì‚¬ìš©ì ì¶”ì²œ</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Slick Slider CSS -->
    <link href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" rel="stylesheet" type="text/css"/>
    <!-- Slick Slider Theme CSS -->
    <link href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css" rel="stylesheet"
          type="text/css"/>
    <!-- jQuery UI CSS -->
    <link href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" rel="stylesheet">
    <style>
        body {
            padding-top: 70px; /* ë„¤ë¹„ê²Œì´ì…˜ ë°” ê³µê°„ í™•ë³´ */
        }
        #map {
            width: 100%;
            height: 500px;
            margin-bottom: 20px;
        }

        /* jQuery UI Autocomplete ì»¤ìŠ¤í„°ë§ˆì´ì§• */
        .ui-autocomplete {
            z-index: 1050; /* Bootstrap ë„¤ë¹„ê²Œì´ì…˜ ë°”ë³´ë‹¤ ìœ„ì— í‘œì‹œë˜ë„ë¡ ì„¤ì • */
            max-height: 300px;
            overflow-y: auto;
            /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì œê±° */
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .ui-menu-item {
            display: block;
            padding: 5px;
        }

        .friend-item {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #ddd;
        }

        .friend-item:hover {
            background-color: #f0f0f0;
        }

        .friend-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        /* ì„ íƒëœ ì¹œêµ¬ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        #selected-friends .selected-friend {
            display: inline-flex;
            align-items: center;
            padding: 5px 10px;
            margin: 5px;
            background-color: #0d6efd;
            color: white;
            border-radius: 15px;
        }

        #selected-friends .selected-friend .remove-friend {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        /* ì¶”ì²œ ë©”ë‰´ ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ */
        .menu-slider .card {
            margin: 0 auto;
        }

        /* ì¶”ì²œ ì´ìœ  ì´ëª¨í‹°ì½˜ */
        .recommendation-reasons {
            font-size: 0.9rem;
            color: #555;
        }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
        #loadingSpinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
        }
    </style>
</head>
<body>
<!-- ë¡œë”© ìŠ¤í”¼ë„ˆ -->
<div id="loadingSpinner">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">KimiNoMenu</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <!-- ë„¤ë¹„ê²Œì´ì…˜ ë§í¬ë“¤ -->
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/}">í™ˆ</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/reviews/write}">ë¦¬ë·° ì‘ì„±</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/profile}">ë§ˆì´ í˜ì´ì§€</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"
                       onclick="event.preventDefault(); document.getElementById('logout-form').submit();">ë¡œê·¸ì•„ì›ƒ</a>
                    <form id="logout-form" th:action="@{/logout}" method="post" style="display:none;">
                    </form>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
<div class="container">
    <h2 class="mt-4 mb-4 text-center">ë‹¤ì¤‘ ì‚¬ìš©ì ì¶”ì²œ</h2>
    <!-- ì¶”ì²œ ì„¤ì • í¼ (í•„ìš” ì‹œ í¼ ì¶”ê°€) -->
    <form class="mb-4" id="recommendationForm">
        <!-- ì¹œêµ¬ ê²€ìƒ‰ ì…ë ¥ í•„ë“œ -->
        <div class="mb-3">
            <label class="form-label" for="friendSearch">ì¹œêµ¬ ê²€ìƒ‰</label>
            <input class="form-control" id="friendSearch" placeholder="ì¹œêµ¬ ì´ë¦„ ë˜ëŠ” ì´ë©”ì¼ë¡œ ê²€ìƒ‰í•˜ì„¸ìš”" type="text">
        </div>

        <!-- ì„ íƒëœ ì¹œêµ¬ í‘œì‹œ ì˜ì—­ -->
        <div class="mb-3" id="selected-friends">
            <!-- ì„ íƒëœ ì¹œêµ¬ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>

        <!-- ì„ í˜¸ ì¹´í…Œê³ ë¦¬ ì„ íƒ -->
        <div class="mb-3">
            <label class="form-label" for="preferredCategories">ì„ í˜¸ ì¹´í…Œê³ ë¦¬</label>
            <select class="form-select" id="preferredCategories" multiple>
                <option value="í•œì‹">í•œì‹</option>
                <option value="ì¤‘ì‹">ì¤‘ì‹</option>
                <option value="ì¼ì‹">ì¼ì‹</option>
                <option value="ì–‘ì‹">ì–‘ì‹</option>
                <option value="ë””ì €íŠ¸">ë””ì €íŠ¸</option>
                <!-- í•„ìš”ì— ë”°ë¼ ì¶”ê°€ ì¹´í…Œê³ ë¦¬ ì˜µì…˜ -->
            </select>
            <small class="form-text text-muted">ì„ í˜¸í•˜ëŠ” ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.</small>
        </div>

        <!-- í‚¤ì›Œë“œ ì…ë ¥ -->
        <div class="mb-3">
            <label class="form-label" for="keywords">í‚¤ì›Œë“œ</label>
            <input class="form-control" id="keywords" placeholder="ì˜ˆ: ë§µê³ , ë‹¬ì½¤í•œ, ì €ì¹¼ë¡œë¦¬" type="text">
            <small class="form-text text-muted">ì„ í˜¸í•˜ëŠ” ë©”ë‰´ì˜ í‚¤ì›Œë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.</small>
        </div>

        <button class="btn btn-primary" id="fetchRecommendations" type="button">ì¶”ì²œ ë°›ê¸°</button>
    </form>

    <!-- í˜„ì¬ ì¢Œí‘œ í‘œì‹œ -->
    <div class="mb-3" id="coordinates">Latitude: -, Longitude: -</div>

    <!-- ë„¤ì´ë²„ ì§€ë„ í‘œì‹œ ì˜ì—­ -->
    <div id="map"></div>

    <!-- ì¶”ì²œ ë©”ë‰´ ëª©ë¡ -->
    <h3>ì¶”ì²œ ë©”ë‰´ ëª©ë¡</h3>
    <div class="menu-slider">
        <!-- ë©”ë‰´ ì¹´ë“œê°€ ì—¬ê¸°ì„œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>

    <!-- ë©”ë‰´ ìŠ¬ë¼ì´ë” ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
    <div class="d-flex justify-content-center mt-3">
        <button class="btn btn-secondary mr-2 slick-prev-menu">ì´ì „</button>
        <button class="btn btn-secondary slick-next-menu">ë‹¤ìŒ</button>
    </div>

    <!-- ì£¼ë³€ ê°€ê²Œ ëª©ë¡ -->
    <h3 class="mt-5">ì£¼ë³€ ê°€ê²Œ ëª©ë¡</h3>
    <div class="row" id="store-list">
        <!-- ê°€ê²Œ ì¹´ë“œê°€ ì—¬ê¸°ì„œ ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
    </div>
</div>

<!-- jQuery, Bootstrap JS, Slick Slider JS, jQuery UI JS -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<!-- ë„¤ì´ë²„ ì§€ë„ API ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ -->
<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=t06c4jgb48&submodules=geocoder"
        type="text/javascript"></script>

<script>
    $(document).ready(function(){
        // ì´ˆê¸° Slick Slider ì„¤ì •
        function initializeSlickSliders() {
            // ì¶”ì²œ ë©”ë‰´ ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
            $('.menu-slider').slick({
                slidesToShow: 3, // í•œ ë²ˆì— 3ê°œì”© í‘œì‹œ
                slidesToScroll: 3, // ìŠ¬ë¼ì´ë“œ ì‹œ 3ê°œì”© ì´ë™
                infinite: false,
                dots: true, // í˜ì´ì§€ë„¤ì´ì…˜ í™œì„±í™”
                arrows: false,
                speed: 500, // ìŠ¬ë¼ì´ë“œ ì „í™˜ ì†ë„ (ë°€ë¦¬ì´ˆ)
                cssEase: 'ease-in-out', // ìŠ¬ë¼ì´ë“œ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜
                responsive: [
                    {
                        breakpoint: 1200,
                        settings: {
                            slidesToShow: 3,
                            slidesToScroll: 3
                        }
                    },
                    {
                        breakpoint: 992,
                        settings: {
                            slidesToShow: 2,
                            slidesToScroll: 2
                        }
                    },
                    {
                        breakpoint: 576,
                        settings: {
                            slidesToShow: 1,
                            slidesToScroll: 1
                        }
                    }
                ]
            });
        }

        // Slick Slider ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ì„¤ì •
        function setSlickNavigation() {
            // ì¶”ì²œ ë©”ë‰´ ë„¤ë¹„ê²Œì´ì…˜
            $('.slick-prev-menu').click(function () {
                $('.menu-slider').slick('slickPrev');
            });
            $('.slick-next-menu').click(function () {
                $('.menu-slider').slick('slickNext');
            });
        }

        // ì´ˆê¸° Slick Slider ë° ë„¤ë¹„ê²Œì´ì…˜ ì„¤ì •
        initializeSlickSliders();
        setSlickNavigation();

        // ì¶”ì²œ ì´ìœ ì— ë”°ë¥¸ ì´ëª¨í‹°ì½˜ ë§¤í•‘
        const recommendationEmojiMap = {
            "ì‚¬ìš©ìë“¤ì´ ì„ í˜¸í•˜ëŠ” ì¹´í…Œê³ ë¦¬": "â¤",
            "ìœ ì‚¬í•œ ì‚¬ìš©ìë“¤ì´ ì„ í˜¸í•˜ëŠ” ìŒì‹": "ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦",
            "ì‚¬ìš©ìê°€ ì…ë ¥í•œ í‚¤ì›Œë“œì™€ ì¼ì¹˜": "ğŸ”",
            "ì„ í˜¸í•˜ëŠ” ì¹´í…Œê³ ë¦¬ì— ì†í•¨": "â­",
            // í•„ìš”ì— ë”°ë¼ ì¶”ê°€ ì´ëª¨í‹°ì½˜ ë§¤í•‘
        };

        // ì„ íƒëœ ì¹œêµ¬ ì €ì¥ ë°°ì—´
        let selectedFriends = [];

        // ìë™ì™„ì„± ëª©ë¡ ì»¤ìŠ¤í„°ë§ˆì´ì§•
        $.widget("custom.friendAutocomplete", $.ui.autocomplete, {
            _renderItem: function (ul, item) {
                var $li = $('<li>');
                var $div = $('<div>').addClass('friend-item').append(
                    $('<img>').attr('src', item.profilePhotoUrl || 'https://via.placeholder.com/40').addClass('friend-photo'),
                    $('<span>').text(item.name + ' (' + item.value + ')')
                );
                return $li.append($div).appendTo(ul);
            }
        });

        // ê²°ê³¼ ì—†ìŒ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•  ìš”ì†Œ ì¶”ê°€
        $('#friendSearch').after('<div id="noResultsMessage" class="text-muted mt-2" style="display: none;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');


        // ì¹œêµ¬ ê²€ìƒ‰ ìë™ì™„ì„± ê¸°ëŠ¥
        $('#friendSearch').friendAutocomplete({
            source: function (request, response) {
                $.ajax({
                    url: '/friendships/search',
                    type: 'GET',
                    dataType: 'json',
                    data: {
                        query: request.term
                    },
                    success: function (data) {
                        if (data.length === 0) {
                            // ê²°ê³¼ê°€ ì—†ì„ ë•Œ ë©”ì‹œì§€ í‘œì‹œ
                            $('#noResultsMessage').show();
                            response([]);
                        } else {
                            $('#noResultsMessage').hide();
                            response($.map(data, function (item) {
                                return {
                                    label: item.userName + ' (' + item.userId + ')',
                                    value: item.userId,
                                    name: item.userName,
                                    profilePhotoUrl: item.profilePhotoUrl
                                };
                            }));
                        }
                    },
                    error: function () {
                        $('#noResultsMessage').show();
                        response([]);
                    }
                });
            },
            minLength: 2,
            select: function (event, ui) {
                // ì¤‘ë³µ ì„ íƒ ë°©ì§€
                if (selectedFriends.includes(ui.item.value)) {
                    alert('ì´ë¯¸ ì„ íƒëœ ì¹œêµ¬ì…ë‹ˆë‹¤.');
                    return false;
                }

                // ì„ íƒëœ ì¹œêµ¬ ì¶”ê°€
                selectedFriends.push(ui.item.value);
                var friendHtml = '<div class="selected-friend" data-user-id="' + ui.item.value + '">'
                    + '<img src="' + (ui.item.profilePhotoUrl || 'https://via.placeholder.com/30') + '" class="friend-photo me-2" style="width:30px; height:30px; border-radius:50%;">'
                    + ui.item.name + ' (' + ui.item.value + ') '
                    + '<span class="remove-friend">&times;</span>'
                    + '<input type="hidden" name="participantUserIds" value="' + ui.item.value + '"/>'
                    + '</div>';
                $('#selected-friends').append(friendHtml);

                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                $(this).val('');
                return false;
            },
            close: function () {
                // ìë™ì™„ì„± ëª©ë¡ì´ ë‹«í ë•Œ "ê²°ê³¼ ì—†ìŒ" ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
                $('#noResultsMessage').hide();
            }
        });

        // ì„ íƒëœ ì¹œêµ¬ ì œê±° ê¸°ëŠ¥
        $('#selected-friends').on('click', '.remove-friend', function () {
            var userId = $(this).siblings('input[name="participantUserIds"]').val();
            selectedFriends = selectedFriends.filter(id => id !== userId);
            $(this).parent('.selected-friend').remove();
        });

        // ì¶”ì²œ ë°›ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ
        $('#fetchRecommendations').click(function () {
            if (selectedFriends.length === 0) {
                alert('ì¶”ì²œì„ ë°›ì„ ì¹œêµ¬ë¥¼ ìµœì†Œ í•œ ëª… ì´ìƒ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            var preferredCategories = $('#preferredCategories').val() || [];
            var keywords = $('#keywords').val().trim();

            // Get current map center coordinates
            var center = map.getCenter();
            var latitude = center.lat();
            var longitude = center.lng();

            // ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ ë° ë²„íŠ¼ ë¹„í™œì„±í™”
            $('#loadingSpinner').show();
            $('#fetchRecommendations').prop('disabled', true);

            // AJAX ìš”ì²­ìœ¼ë¡œ ì¶”ì²œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            $.ajax({
                url: '/recommendations/nearby-menus-with-friends',
                type: 'POST',
                data: {
                    latitude: latitude,
                    longitude: longitude,
                    radius: 1000, // ì˜ˆì‹œ ë°˜ê²½
                    limit: 10,    // ì¶”ì²œí•  ë©”ë‰´ ê°œìˆ˜
                    participantUserIds: selectedFriends,
                    preferredCategories: preferredCategories,
                    keywords: keywords
                },
                success: function (response) {
                    displayRecommendedMenus(response.recommendedMenus);
                    displayNearbyStores(response.nearbyStores);
                },
                error: function (xhr, status, error) {
                    alert("ì¶”ì²œ ë©”ë‰´ ë° ê°€ê²Œë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                },
                complete: function () {
                    // ë¡œë”© ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê³  ë²„íŠ¼ í™œì„±í™”
                    $('#loadingSpinner').hide();
                    $('#fetchRecommendations').prop('disabled', false);
                }
            });
        });

        // Function to display recommended menus on the page
        function displayRecommendedMenus(menus) {
            const menuSlider = $('.menu-slider');
            // ìŠ¬ë¼ì´ë”ê°€ ì´ë¯¸ ì´ˆê¸°í™”ë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (menuSlider.hasClass('slick-initialized')) {
                menuSlider.slick('unslick'); // ìŠ¬ë¼ì´ë” íŒŒê´´
            }

            menuSlider.empty(); // ê¸°ì¡´ ìŠ¬ë¼ì´ë“œ ì œê±°

            if (menus.length === 0) {
                menuSlider.append('<div><p class="text-muted">ì¶”ì²œ ë©”ë‰´ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>');
                return;
            }

            menus.forEach(function (menu) {
                const menuCard = `
                    <div>
                        <div class="card h-100">
                            <img src="${menu.pictureUrl || '/images/default-menu.png'}" class="card-img-top menu-photo" alt="${menu.name}">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${menu.name}</h5>
                                <p class="card-text"><strong>ê°€ê²©:</strong> ${menu.price}ì›</p>
                                <p class="card-text"><strong>ì¹´í…Œê³ ë¦¬:</strong> ${formatCategories(menu.categories)}</p>
                                <p class="recommendation-reasons"><em>${formatRecommendationReasons(menu.recommendationReasons)}</em></p> <!-- ì¶”ì²œ ì´ìœ  í‘œì‹œ -->
                                <a href="/menu/${menu.menuId}" class="btn btn-primary mt-auto">ìì„¸íˆ ë³´ê¸°</a>
                            </div>
                        </div>
                    </div>
                `;
                menuSlider.append(menuCard);
            });

            // ìŠ¬ë¼ì´ë” ë‹¤ì‹œ ì´ˆê¸°í™”
            initializeSlickSliders();
            setSlickNavigation();
        }

        // Function to format recommendation reasons with emojis
        function formatRecommendationReasons(reasons) {
            if (!reasons || reasons.length === 0) return '';
            return reasons.map(reason => {
                const emoji = recommendationEmojiMap[reason] || ''; // ë§¤í•‘ëœ ì´ëª¨í‹°ì½˜ ë˜ëŠ” ë¹ˆ ë¬¸ìì—´
                return `${emoji} ${reason}`;
            }).join(' & ');
        }

        // Function to format categories into badges
        function formatCategories(categories) {
            if (!categories || categories.length === 0) return 'ì—†ìŒ';
            return categories.map(category => `<span class="badge bg-secondary badge-category">${category.categoryName}</span>`).join(' ');
        }

        // Function to display nearby stores on the page and add markers to the map
        function displayNearbyStores(stores) {
            const storeList = $('#store-list');
            storeList.empty(); // ê¸°ì¡´ ê°€ê²Œ ëª©ë¡ ì œê±°

            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            storeMarkers.forEach(marker => marker.setMap(null));
            storeMarkers = [];

            if (stores.length === 0) {
                storeList.append('<p class="text-muted">ì£¼ë³€ ê°€ê²Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>');
                return;
            }

            stores.forEach(function (store) {
                const storeCard = `
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <img src="${store.photoUrls && store.photoUrls.length > 0 ? store.photoUrls[0] : '/images/default-store.png'}" class="card-img-top store-photo" alt="${store.name}">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${store.name}</h5>
                                <p class="card-text"><strong>ì¹´í…Œê³ ë¦¬:</strong> ${store.category}</p>
                                <p class="card-text"><strong>ì „í™”ë²ˆí˜¸:</strong> ${store.phoneNumber}</p>
                                <a href="/stores/${store.storeId}" class="btn btn-primary mt-auto">ê°€ê²Œ ë³´ê¸°</a>
                            </div>
                        </div>
                    </div>
                `;
                storeList.append(storeCard);

                // ì§€ë„ì— ê°€ê²Œ ë§ˆì»¤ ì¶”ê°€
                const storeMarker = new naver.maps.Marker({
                    position: new naver.maps.LatLng(store.latitude, store.longitude),
                    map: map,
                    title: store.name
                });

                // ë§ˆì»¤ í´ë¦­ ì‹œ ì •ë³´ì°½ í‘œì‹œ (ì„ íƒ ì‚¬í•­)
                const infoWindow = new naver.maps.InfoWindow({
                    content: `<div style="width:200px;"><strong>${store.name}</strong><br/>${store.address}</div>`
                });

                naver.maps.Event.addListener(storeMarker, 'click', function () {
                    infoWindow.open(map, storeMarker);
                });

                storeMarkers.push(storeMarker);
            });
        }

        // ì§€ë„ ì´ˆê¸°í™” ë³€ìˆ˜
        var map;
        var userMarker;
        var storeMarkers = [];

        // Geolocationì„ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìì˜ í˜„ì¬ ìœ„ì¹˜ ê°€ì ¸ì˜¤ê¸°
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showPosition, showError);
        } else {
            alert("Geolocationì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.");
            // ê¸°ë³¸ ìœ„ì¹˜ ì„¤ì • (ì˜ˆ: ì„œìš¸ ì‹œì²­)
            initializeMap(37.5665, 126.9780);
        }

        // í˜„ì¬ ìœ„ì¹˜ í‘œì‹œ ë° ì§€ë„ ì´ˆê¸°í™”
        function showPosition(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;

            // ì§€ë„ ì´ˆê¸°í™”
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(latitude, longitude),
                zoom: 15
            });

            // ì‚¬ìš©ì ìœ„ì¹˜ ë§ˆì»¤ ì¶”ê°€
            userMarker = new naver.maps.Marker({
                position: new naver.maps.LatLng(latitude, longitude),
                map: map,
                title: "ë‚´ ìœ„ì¹˜"
            });

            // ì´ˆê¸° ì¢Œí‘œ í‘œì‹œ
            $('#coordinates').text(`Latitude: ${latitude}, Longitude: ${longitude}`);
        }

        // Geolocation ì—ëŸ¬ ì²˜ë¦¬
        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ í—ˆìš©í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                    break;
                case error.POSITION_UNAVAILABLE:
                    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    break;
                case error.TIMEOUT:
                    alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    break;
                case error.UNKNOWN_ERROR:
                    alert("ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    break;
            }
        }

        // ì¥ì†Œ ê²€ìƒ‰ ê¸°ëŠ¥ êµ¬í˜„
        $('#mapSearch').on('keypress', function (e) {
            if (e.which == 13) { // Enter í‚¤ ëˆŒë €ì„ ë•Œ
                e.preventDefault();
                var query = $(this).val();
                if (query.length > 0) {
                    searchAddress(query);
                }
            }
        });

        function searchAddress(query) {
            naver.maps.Service.geocode({
                query: query
            }, function (status, response) {
                if (status !== naver.maps.Service.Status.OK) {
                    return alert('ì¥ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                var result = response.v2;
                var items = result.addresses;

                if (items.length > 0) {
                    var item = items[0];
                    var lat = parseFloat(item.y);
                    var lng = parseFloat(item.x);
                    var position = new naver.maps.LatLng(lat, lng);

                    map.setCenter(position);
                    marker.setPosition(position);
                    $('#location').val(item.address);
                    $('#coordinates').text(`Latitude: ${lat}, Longitude: ${lng}`);
                } else {
                    alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            });
        }

        // ì¢Œí‘œë¥¼ ì£¼ì†Œë¡œ ë³€í™˜í•˜ì—¬ ì…ë ¥ í•„ë“œì— ì—…ë°ì´íŠ¸
        function getAddress(latlng) {
            naver.maps.Service.reverseGeocode({
                coords: latlng,
                orders: 'addr',
                language: 'ko'
            }, function (status, response) {
                if (status !== naver.maps.Service.Status.OK) {
                    return alert('ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                var result = response.v2;
                var items = result.addresses;

                if (items.length > 0) {
                    var addressDetail = items[0].roadAddress || items[0].jibunAddress;
                    $('#location').val(addressDetail);
                    $('#coordinates').text(`Latitude: ${latlng.lat()}, Longitude: ${latlng.lng()}`);
                }
            });
        }
    });
</script>
</body>
</html>
