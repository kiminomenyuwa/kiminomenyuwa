<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>다중 사용자 추천</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Slick Slider CSS -->
    <link href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css" rel="stylesheet" type="text/css"/>
    <!-- Slick Slider Theme CSS -->
    <link href="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick-theme.css" rel="stylesheet" type="text/css"/>
    <!-- jQuery UI CSS -->
    <link href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css" rel="stylesheet">
    <style>
        body, html {
            height: 100%;
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f8f9fa;
        }

        .navbar {
            background-color: #343a40;
        }

        .content-wrapper {
            display: flex;
            height: calc(100vh - 56px);
        }

        .menu-container {
            width: 50%;
            overflow-y: auto;
            padding: 20px;
            background-color: #ffffff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .map-container {
            width: 50%;
            position: relative;
        }

        #map {
            height: 100%;
        }

        .menu-photo {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 8px 8px 0 0;
        }

        .recommendation-section {
            margin-bottom: 30px;
        }

        .map-buttons {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .filter-bar {
            background-color: #f1f3f5;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .card-body {
            padding: 1.25rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .card-text {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .slick-slide {
            margin: 0 10px;
        }

        .slick-list {
            margin: 0 -10px;
        }

        #friendSearch {
            margin-bottom: 15px;
        }

        #selected-friends {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
        }

        .selected-friend {
            display: inline-flex;
            align-items: center;
            background-color: #e9ecef;
            padding: 5px 12px;
            margin: 5px;
            border-radius: 20px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .selected-friend:hover {
            background-color: #dee2e6;
        }

        .friend-photo {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 8px;
            object-fit: cover;
        }

        .remove-friend {
            margin-left: 8px;
            cursor: pointer;
            color: #dc3545;
            font-size: 1.2rem;
        }

        .ui-autocomplete {
            max-height: 200px;
            overflow-y: auto;
            overflow-x: hidden;
            border-radius: 0 0 4px 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .ui-menu-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .ui-menu-item:hover {
            background-color: #f8f9fa;
        }

        .ui-menu-item img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            margin-right: 10px;
            object-fit: cover;
        }

        .ui-menu-item span {
            font-size: 0.9rem;
        }

        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #0056b3;
        }

        /* 로딩 스피너 중앙 배치 */
        .food-loading-spinner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: none; /* 기본적으로 숨김 */
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .food-loading-spinner i {
            font-size: 40px;
            margin: 0 10px;
            animation: foodSpin 1s linear infinite;
        }

        .food-loading-spinner i:nth-child(1) {
            color: #FF6347;
        }

        .food-loading-spinner i:nth-child(2) {
            color: #DEB887;
            animation-delay: 0.25s;
        }

        .food-loading-spinner i:nth-child(3) {
            color: #87CEFA;
            animation-delay: 0.5s;
        }

        .food-loading-spinner i:nth-child(4) {
            color: #D2691E;
            animation-delay: 0.75s;
        }

        @keyframes foodSpin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<!-- 네비게이션 바 -->
<body>
<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">KimiNoMenu</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/}">홈</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/reviews/write}">리뷰 작성</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" th:href="@{/profile}">마이 페이지</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#"
                       onclick="event.preventDefault(); document.getElementById('logout-form').submit();">로그아웃</a>
                    <form id="logout-form" th:action="@{/logout}" method="post" style="display:none;"></form>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="content-wrapper">
    <!-- 메뉴 리스트 및 필터 영역 -->
    <div class="menu-container">
        <h2 class="mt-4 mb-4">다중 사용자 추천</h2>

        <!-- 필터링 및 카테고리 선택 바 -->
        <div class="filter-bar">
            <div class="mb-3">
                <label for="friendSearch" class="form-label">친구 검색</label>
                <input class="form-control" id="friendSearch" placeholder="친구 이름 또는 이메일로 검색하세요" type="text">
            </div>
            <div id="selected-friends"></div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="preferredCategories" class="form-label">선호 카테고리</label>
                    <select class="form-select" id="preferredCategories" multiple>
                        <option value="한식">한식</option>
                        <option value="중식">중식</option>
                        <option value="일식">일식</option>
                        <option value="양식">양식</option>
                        <option value="디저트">디저트</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="keywords" class="form-label">키워드</label>
                    <input class="form-control" id="keywords" placeholder="예: 맵고, 달콤한, 저칼로리" type="text">
                </div>
            </div>
            <!-- 약속 시간 입력 필드 추가 -->
            <div class="mb-3">
                <label for="appointmentTime" class="form-label">약속 시간</label>
                <input class="form-control" id="appointmentTime" type="datetime-local">
            </div>
            <button class="btn btn-primary w-100" id="fetchRecommendations" type="button">추천 받기</button>
        </div>

        <!-- 추천 메뉴 목록 -->
        <div class="recommendation-section">
            <h3>추천 메뉴</h3>
            <div class="menu-slider" id="recommended-menus"></div>
        </div>

        <!-- 주변 가게 목록 -->
        <div class="recommendation-section">
            <h3>주변 가게</h3>
            <div class="row" id="store-list"></div>
        </div>
    </div>

    <!-- 지도 영역 -->
    <div class="map-container">
        <div id="map"></div>
        <div class="map-buttons">
            <button class="btn btn-primary btn-sm mb-2" id="centerOnUser">현재 위치로</button>
            <button class="btn btn-secondary btn-sm" id="showAllStores">모든 가게 보기</button>
        </div>
    </div>
</div>

<!-- 1위 메뉴 팝업 -->
<div class="modal fade" id="topMenuModal" tabindex="-1" aria-labelledby="topMenuModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"> <!-- modal-dialog-centered 클래스 추가 -->
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="topMenuModalLabel">1위 추천 메뉴</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="topMenuContent">
                <!-- 1위 메뉴 내용이 여기에 동적으로 추가됩니다 -->
            </div>
        </div>
    </div>
</div>

<!-- 로딩 스피너 중앙 배치 -->
<div class="food-loading-spinner">
    <i class="fas fa-pizza-slice"></i>
    <i class="fas fa-hamburger"></i>
    <i class="fas fa-ice-cream"></i>
    <i class="fas fa-cookie"></i>
</div>

<!-- 스크립트 -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=t06c4jgb48&submodules=geocoder"></script>

<script>
    $(document).ready(function () {
        let map;
        let markers = [];
        let appointmentMarker = null;
        let selectedFriends = [];
        let appointmentLocation = null;

        // 지도 초기화
        function initMap() {
            map = new naver.maps.Map('map', {
                center: new naver.maps.LatLng(37.5665, 126.9780),
                zoom: 15
            });

            // 지도 클릭 이벤트 추가
            naver.maps.Event.addListener(map, 'click', function (e) {
                setAppointmentLocation(e.latlng);
            });

            // 지도 드래그 종료 이벤트 추가
            naver.maps.Event.addListener(map, 'dragend', function () {
                const center = map.getCenter();
                setAppointmentLocation(center);
            });
        }

        // 약속 장소 설정 함수
        function setAppointmentLocation(latlng) {
            // 기존 약속 마커가 있다면 제거
            if (appointmentMarker) {
                appointmentMarker.setMap(null);
            }

            // 새 약속 마커 추가 (기본 마커 사용)
            appointmentMarker = new naver.maps.Marker({
                position: latlng,
                map: map,
                icon: {
                    content: '<i class="fas fa-map-marker-alt" style="font-size:24px;color:red;"></i>',
                    anchor: new naver.maps.Point(12, 24)
                }
            });

            // 약속 위치 저장
            appointmentLocation = {
                latitude: latlng.lat(),
                longitude: latlng.lng()
            };

            // 약속 장소 정보 표시
            const infoWindow = new naver.maps.InfoWindow({
                content: `<div style="padding:10px;min-width:200px;">약속 장소</div>`
            });
            infoWindow.open(map, appointmentMarker);
        }

        // 자동완성 설정
        $("#friendSearch").autocomplete({
            source: function (request, response) {
                $.ajax({
                    url: "/friendships/search",
                    dataType: "json",
                    data: {query: request.term},
                    success: function (data) {
                        response($.map(data, function (item) {
                            return {
                                label: item.userName + " (" + item.userId + ")",
                                value: item.userId,
                                name: item.userName,
                                profilePhotoUrl: item.profilePhotoUrl
                            };
                        }));
                    }
                });
            },
            minLength: 2,
            select: function (event, ui) {
                if (!selectedFriends.includes(ui.item.value)) {
                    selectedFriends.push(ui.item.value);
                    $("#selected-friends").append(
                        `<span class="selected-friend" data-id="${ui.item.value}">
                            <img src="${ui.item.profilePhotoUrl}" alt="${ui.item.name}" class="friend-photo" />
                            <span>${ui.item.name}</span>
                            <i class="fas fa-times remove-friend"></i>
                        </span>`
                    );
                } else {
                    alert("이미 선택된 친구입니다.");
                }
                $(this).val("");
                return false;
            }
        }).autocomplete("instance")._renderItem = function (ul, item) {
            return $("<li>")
                .append(`<div>
                        <img src="${item.profilePhotoUrl}" alt="${item.name}" />
                        <span>${item.label}</span>
                     </div>`)
                .appendTo(ul);
        };

        // 친구 제거
        $(document).on("click", ".remove-friend", function () {
            const friendId = $(this).parent().data("id");
            selectedFriends = selectedFriends.filter(id => id !== friendId);
            $(this).parent().remove();
        });

        // 추천 받기
        $("#fetchRecommendations").click(function () {
            if (selectedFriends.length === 0) {
                alert("최소 한 명의 친구를 선택해주세요.");
                return;
            }

            if (!appointmentLocation) {
                alert("약속 장소를 설정해주세요.");
                return;
            }

            const appointmentTime = $("#appointmentTime").val();
            if (!appointmentTime) {
                alert("약속 시간을 입력해주세요.");
                return;
            }

            // 지도 중심을 약속 장소로 설정
            map.setCenter(new naver.maps.LatLng(appointmentLocation.latitude, appointmentLocation.longitude));

            $(".food-loading-spinner").css("display", "flex"); // 로딩 스피너 표시

            $.ajax({
                url: "/recommendations/nearby-menus-with-friends",
                method: "POST",
                data: {
                    latitude: appointmentLocation.latitude,
                    longitude: appointmentLocation.longitude,
                    radius: 1000,
                    limit: 10,
                    participantUserIds: selectedFriends,
                    preferredCategories: $("#preferredCategories").val(),
                    keywords: $("#keywords").val(),
                    appointmentTime: appointmentTime
                },
                success: function (response) {
                    displayRecommendedMenus(response.recommendedMenus);
                    displayNearbyStores(response.nearbyStores);
                    updateMap(response.nearbyStores);
                    if(response.recommendedMenus.length > 0){
                        showTopMenuPopup(response.recommendedMenus[0]); // 1위 메뉴 팝업 표시
                    }
                },
                error: function () {
                    alert("추천을 가져오는데 실패했습니다.");
                },
                complete: function () {
                    $(".food-loading-spinner").css("display", "none"); // 로딩 스피너 숨기기
                }
            });
        });

        // 추천 메뉴 표시
        function displayRecommendedMenus(menus) {
            const slider = $("#recommended-menus");
            slider.empty();
            menus.forEach(menu => {
                slider.append(`
                <div class="card">
                    <img src="${menu.pictureUrl || '/images/default-menu.png'}" class="card-img-top menu-photo" alt="${menu.name}">
                    <div class="card-body">
                        <h5 class="card-title">${menu.name}</h5>
                        <p class="card-text">가격: ${menu.price}원</p>
                        <p class="card-text">${menu.categories.map(c => c.categoryName).join(", ")}</p>
                        <a href="/stores/${menu.storeId}" class="btn btn-primary">가게 보러가기</a>
                    </div>
                </div>
            `);
            });

            // 기존 슬릭 인스턴스 제거
            if (slider.hasClass('slick-initialized')) {
                slider.slick('unslick');
            }

            // 새로운 슬릭 슬라이더 초기화
            slider.slick({
                slidesToShow: 3,
                slidesToScroll: 1,
                autoplay: true,
                autoplaySpeed: 3000,
                responsive: [
                    {
                        breakpoint: 768,
                        settings: {
                            slidesToShow: 2
                        }
                    },
                    {
                        breakpoint: 576,
                        settings: {
                            slidesToShow: 1
                        }
                    }
                ]
            });
        }

        // 1위 메뉴 팝업 표시
        function showTopMenuPopup(topMenu) {
            const modalContent = `
            <div class="card">
                <img src="${topMenu.pictureUrl || '/images/default-menu.png'}" class="card-img-top menu-photo" alt="${topMenu.name}">
                <div class="card-body">
                    <h5 class="card-title">${topMenu.name}</h5>
                    <p class="card-text">가격: ${topMenu.price}원</p>
                    <p class="card-text">${topMenu.categories.map(c => c.categoryName).join(", ")}</p>
                    <a href="/stores/${topMenu.storeId}" class="btn btn-primary">가게 보러가기</a>
                </div>
            </div>
        `;
            $("#topMenuContent").html(modalContent);
            new bootstrap.Modal(document.getElementById('topMenuModal')).show();
        }

        // 주변 가게 표시
        function displayNearbyStores(stores) {
            const storeList = $("#store-list");
            storeList.empty();
            stores.forEach(store => {
                storeList.append(`
                <div class="col-md-4 mb-4">
                    <div class="card">
                        <img src="${store.photoUrls[0] || '/images/default-store.png'}" class="card-img-top menu-photo" alt="${store.name}">
                        <div class="card-body">
                            <h5 class="card-title">${store.name}</h5>
                            <p class="card-text">${store.category}</p>
                            <p class="card-text">${store.phoneNumber}</p>
                        </div>
                    </div>
                </div>
            `);
            });
        }

        // 지도 업데이트
        function updateMap(stores) {
            // 기존 마커 제거
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            // 새 마커 추가
            stores.forEach(store => {
                const marker = new naver.maps.Marker({
                    position: new naver.maps.LatLng(store.latitude, store.longitude),
                    map: map,
                    title: store.name
                });
                markers.push(marker);

                // 마커 클릭 이벤트
                naver.maps.Event.addListener(marker, 'click', function () {
                    const infoWindow = new naver.maps.InfoWindow({
                        content: `
                        <div style="padding:10px;min-width:200px;">
                            <h5>${store.name}</h5>
                            <p>${store.category}</p>
                            <p>${store.phoneNumber}</p>
                        </div>
                    `
                    });
                    infoWindow.open(map, marker);
                });
            });

            // 모든 마커가 보이도록 지도 범위 조정
            if (markers.length > 0) {
                const bounds = new naver.maps.LatLngBounds();
                markers.forEach(marker => bounds.extend(marker.getPosition()));
                map.fitBounds(bounds);
            }
        }

        // 현재 위치로 이동
        $("#centerOnUser").click(function () {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const userLocation = new naver.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    map.setCenter(userLocation);
                    setAppointmentLocation(userLocation); // 약속 장소를 현재 위치로 설정
                }, function () {
                    alert("위치 정보를 가져올 수 없습니다.");
                });
            } else {
                alert("이 브라우저에서는 위치 정보를 지원하지 않습니다.");
            }
        });

        // 모든 가게 보기
        $("#showAllStores").click(function () {
            if (markers.length > 0) {
                const bounds = new naver.maps.LatLngBounds();
                markers.forEach(marker => bounds.extend(marker.getPosition()));
                map.fitBounds(bounds);
            } else {
                alert("표시할 가게가 없습니다.");
            }
        });

        // 지도 초기화
        initMap();

        // 페이지 로드 시 현재 위치로 지도 중심 설정
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                const userLocation = new naver.maps.LatLng(position.coords.latitude, position.coords.longitude);
                map.setCenter(userLocation);
                setAppointmentLocation(userLocation); // 약속 장소를 현재 위치로 설정
            }, function () {
                console.log("위치 정보를 가져올 수 없습니다.");
                // 위치 정보를 가져올 수 없는 경우, 기본 위치로 설정
                const defaultLocation = new naver.maps.LatLng(37.5665, 126.9780);
                map.setCenter(defaultLocation);
                setAppointmentLocation(defaultLocation);
            });
        } else {
            console.log("이 브라우저에서는 위치 정보를 지원하지 않습니다.");
            // 위치 정보를 지원하지 않는 경우, 기본 위치로 설정
            const defaultLocation = new naver.maps.LatLng(37.5665, 126.9780);
            map.setCenter(defaultLocation);
            setAppointmentLocation(defaultLocation);
        }
    });
</script>
</body>
</html>
