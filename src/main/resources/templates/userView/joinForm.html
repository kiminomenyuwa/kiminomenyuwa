<!DOCTYPE html>
<html
        xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
        xmlns:th="http://www.thymeleaf.org"
        xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
        layout:decorate="~{homeLayout}">

<!-- 페이지별 css -->
<style layout:fragment="styles">
    /* 추가적인 커스텀 스타일이 필요하다면 여기에 작성 */
    .required::after {
        content: "*";
        color: red;
        margin-left: 2px;
    }
</style>

<div layout:fragment="content">
    <div class="container mt-5 ">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card shadow-sm">
                    <div class="card-header text-center bg-primary text-white">
                        <h4 class="mb-0">회원가입</h4>
                    </div>
                    <div class="card-body">
                        <form id="joinForm" action="/user/join" method="post" enctype="multipart/form-data" novalidate>
                            <!-- ID 입력 -->
                            <div class="mb-3">
                                <label for="id" class="form-label required">아이디</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="id" name="userId"
                                           placeholder="ID 중복확인 이용" readonly required>
                                    <button type="button" class="btn btn-outline-secondary" id="checkIdBtn">ID 중복확인
                                    </button>
                                    <div class="invalid-feedback">
                                        아이디를 입력하세요.
                                    </div>
                                </div>
                            </div>

                            <!-- 비밀번호 입력 -->
                            <div class="mb-3">
                                <label for="password" class="form-label required">비밀번호</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="password"
                                           name="passwordHash" placeholder="비밀번호 입력" required>
                                    <button type="button" class="btn btn-outline-secondary" id="togglePassword"
                                            aria-label="비밀번호 표시" aria-pressed="false">
                                        <i class="fas fa-eye" id="togglePasswordIcon"></i>
                                    </button>
                                    <div class="invalid-feedback">
                                        비밀번호를 입력하세요.
                                    </div>
                                </div>
                            </div>

                            <!-- 비밀번호 확인 -->
                            <div class="mb-3">
                                <label for="password2" class="form-label required">비밀번호 확인</label>
                                <input type="password" class="form-control" id="password2" placeholder="비밀번호 다시 입력"
                                       required>
                                <div class="invalid-feedback">
                                    비밀번호가 일치하지 않습니다.
                                </div>
                            </div>

                            <!-- 이름 입력 -->
                            <div class="mb-3">
                                <label for="name" class="form-label required">이름</label>
                                <input type="text" class="form-control" id="name" name="name" placeholder="이름 입력"
                                       required>
                                <div class="invalid-feedback">
                                    이름을 입력하세요.
                                </div>
                            </div>

                            <!-- 생년월일 입력 -->
                            <div class="mb-3">
                                <label for="birthDate" class="form-label">생년월일</label>
                                <input type="date" class="form-control" id="birthDate" name="birthDate">
                            </div>

                            <!-- 성별 선택 -->
                            <div class="mb-3">
                                <label for="gender" class="form-label required">성별</label>
                                <select class="form-select" id="gender" name="gender" required>
                                    <option value="">선택</option>
                                    <option value="male">남</option>
                                    <option value="female">여</option>
                                </select>
                                <div class="invalid-feedback">
                                    성별을 선택하세요.
                                </div>
                            </div>

                            <!-- 이메일 입력 -->
                            <div class="mb-3">
                                <label for="email" class="form-label required">이메일</label>
                                <input type="email" class="form-control" id="email" name="email" placeholder="이메일 입력"
                                       required>
                                <div class="invalid-feedback">
                                    유효한 이메일을 입력하세요.
                                </div>
                            </div>

                            <!-- 우편번호 및 주소 검색 -->
                            <div class="mb-3">
                                <label for="zipcode" class="form-label">우편번호</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="zipcode" name="zipcode"
                                           th:value="${zipcode}" readonly placeholder="주소검색 기능 사용">
                                    <button type="button" class="btn btn-outline-secondary" id="searchAddressBtn">주소검색
                                    </button>
                                </div>
                            </div>

                            <!-- 도로명 주소 -->
                            <div class="mb-3">
                                <label for="roadNameAddress" class="form-label">도로명주소</label>
                                <input type="text" class="form-control" id="roadNameAddress"
                                       name="roadNameAddress" th:value="${roadNameAddress}" readonly
                                       placeholder="주소검색 기능 사용">
                            </div>

                            <!-- 상세주소 -->
                            <div class="mb-3">
                                <label for="detailAddress" class="form-label">상세주소</label>
                                <input type="text" class="form-control" id="detailAddress" name="detailAddress"
                                       th:value="${detailAddress}" placeholder="상세주소를 입력하세요">
                            </div>

                            <!-- 전화번호 -->
                            <div class="mb-3">
                                <label for="phoneNumber" class="form-label">전화번호</label>
                                <input type="tel" class="form-control" id="phoneNumber" name="phoneNumber"
                                       placeholder="전화번호 입력">
                            </div>

                            <!-- 프로필 사진 업로드 -->
                            <div class="mb-3">
                                <label for="profileImage" class="form-label">프로필 사진</label>
                                <input type="file" class="form-control" id="profileImage" name="profileImage"
                                       accept="image/*">
                                <input type="hidden" id="profileImgUuid" name="profileImgUuid">
                            </div>

                            <!-- 제출 버튼 -->
                            <div class="d-flex justify-content-between">
                                <button type="submit" class="btn btn-primary">가입</button>
                                <button type="reset" class="btn btn-secondary">다시 쓰기</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 페이지별 스크립트 삽입 -->
<div layout:fragment="scripts">
    <!-- 카카오 도로명주소 서비스 호출 -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <title>회원가입</title>
    <script>
        $(document).ready(function () {
            // 회원가입 폼 유효성검사
            $("#joinForm").submit(validation);
            // ID 중복확인 팝업
            $("#checkIdBtn").click(checkIdAvailability);
            // 도로명주소 새창 팝업
            $("#searchAddressBtn").click(kakaoRoadAddress);
            // 프로필 사진 선택시 이벤트
            $("#profileImage").change(saveProfile);
        });

        // ID 중복확인 기능
        function checkIdAvailability() {
            let w = window.open(
                "idCheck",
                "win",
                "location=0,left=500px,top=200px,width=500px,height=400px"
            );
        }

        // 카카오 도로명주소 사용
        function kakaoRoadAddress() {
            new daum.Postcode({
                oncomplete: function (data) {
                    // 카카오 도로명주소에서 받아온 data html에 반영
                    $("#zipcode").val(data.zonecode);
                    $("#roadNameAddress").val(data.roadAddress);
                    $("#detailAddress").focus();
                },
            }).open();
        }

        // 프로필 사진 등록
        function saveProfile() {
            let formData = new FormData();
            formData.append("profileImage", $("#profileImage")[0].files[0]);
            formData.append("userId", $("#id").val()); // 현재 폼에 입력된 userId도 같이 전송

            $.ajax({
                url: "/user/uploadProfile",
                type: "post",
                data: formData,
                datatype: "json",
                processData: false,
                contentType: false,
                success: function (profilePhotoDTO) {
                    alert("프로필 사진 업로드 성공");
                    $("#profileImgUuid").val(profilePhotoDTO.savedName);
                },
                error: function () {
                    alert("프로필 사진 업로드 실패!");
                },
            });
        }

        // 유효성 검사
        function validation() {
            let id = $("#id").val();
            let pw = $("#password").val();
            let pw2 = $("#password2").val();
            let name = $("#name").val();
            let birthDate = $("#birthDate").val();
            let gender = $('select[name="gender"]').val();
            let email = $("#email").val();
            let zipcode = $("#zipcode").val();
            let phoneNumber = $("#phoneNumber").val();

            // ID 유효성 검사
            if (id.length < 3 || id.length > 10) {
                alert("ID는 3~10자로 입력하세요.");
                return false;
            }
            // 비밀번호 길이 검사
            if (pw.length < 3 || pw.length > 30) {
                alert("비밀번호는 3~30자로 입력하세요");
                return false;
            }
            // 비밀번호 확인
            if (pw != pw2) {
                alert("비밀번호가 일치하지 않습니다.");
                return false;
            }
            // 이름 입력 검사
            if (name == "") {
                alert("이름을 입력하세요");
                return false;
            }
            // 성별 선택 여부 확인
            if (gender == "") {
                alert("성별을 선택하세요.");
                return false;
            }
            // 이메일 입력 여부 확인
            if (email == "") {
                alert("이메일을 입력하세요.");
                return false;
            }
            // 우편번호 입력 여부 확인
            if (zipcode == "") {
                alert("우편번호를 입력하세요.");
                return false;
            }
            // 전화번호 입력 여부 확인
            if (phoneNumber == "") {
                alert("전화번호를 입력하세요.");
                return false;
            }
            return true;
        }
    </script>
</div>
</html>
