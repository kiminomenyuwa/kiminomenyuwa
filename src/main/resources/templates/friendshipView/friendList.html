<!DOCTYPE html>
<html layout:decorate="~{myPageLayout}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">

<!-- styles 프래그먼트 -->
<th:block layout:fragment="styles">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'SUIT-Regular', sans-serif;
        }

        h1, h3 {
            font-weight: 600;
        }

        .home-link {
            display: inline-block;
            padding: 8px 16px;
            background-color: #4caf50;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
        }

        .home-link:hover {
            background-color: #45a049;
        }

        .container {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            margin-top: 30px;
        }

        .table th, .table td {
            vertical-align: middle;
        }

        .btn-primary, .btn-success, .btn-danger {
            padding: 6px 12px;
        }

        .modal-header {
            background-color: #007bff;
            color: white;
        }

        .modal-content {
            border-radius: 10px;
        }

        .modal-body input {
            margin-bottom: 10px;
        }

        #searchResult {
            padding: 15px;
            background-color: #f1f1f1;
            border-radius: 8px;
            margin-top: 15px;
        }

        /* Empty state 스타일 */
        .empty-state {
            text-align: center;
            padding: 40px 0;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 48px;
            color: #ced4da;
        }

        .empty-state p {
            margin-top: 10px;
            font-size: 18px;
        }
    </style>
</th:block>

<!-- content 프래그먼트 -->
<main layout:fragment="content">
    <div class="container">
        <h1 class="text-center mb-4">친구 관리</h1>
        <div class="d-flex justify-content-between mb-3">
            <button class="btn btn-primary" data-bs-target="#friendSearchModal" data-bs-toggle="modal" type="button">
                친구 추가
            </button>
        </div>

        <div class="row">
            <div class="col-md-4">
                <h3>친구 목록</h3>
                <table class="table table-hover table-bordered mt-3">
                    <thead class="table-light">
                    <tr>
                        <th>친구 ID</th>
                        <th>상태</th>
                        <th>작업</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${#lists.isEmpty(acceptedFriendIds)}">
                        <td colspan="3">
                            <div class="empty-state">
                                <i class="fas fa-user-friends"></i>
                                <p>친구가 없습니다.</p>
                            </div>
                        </td>
                    </tr>
                    <tr th:each="friend : ${acceptedFriendIds}" th:unless="${#lists.isEmpty(acceptedFriendIds)}">
                        <td th:text="${friend}">친구 ID</td>
                        <td>친구</td>
                        <td>
                            <button class="btn btn-danger btn-sm delete-friend-btn" th:data-friend-id="${friend}"
                                    type="button">
                                삭제
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="col-md-4">
                <h3>받은 친구 요청</h3>
                <table class="table table-hover table-bordered mt-3">
                    <thead class="table-light">
                    <tr>
                        <th>요청한 사용자 ID</th>
                        <th>작업</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${#lists.isEmpty(receivedRequests)}">
                        <td colspan="2">
                            <div class="empty-state">
                                <i class="fas fa-inbox"></i>
                                <p>받은 친구 요청이 없습니다.</p>
                            </div>
                        </td>
                    </tr>
                    <tr th:each="request : ${receivedRequests}" th:unless="${#lists.isEmpty(receivedRequests)}">
                        <td th:text="${request.userId}">요청한 사용자 ID</td>
                        <td>
                            <button class="btn btn-success btn-sm accept-btn" th:data-request-id="${request.friendshipId}"
                                    type="button">
                                수락
                            </button>
                            <button class="btn btn-danger btn-sm decline-btn" th:data-request-id="${request.friendshipId}"
                                    type="button">
                                거절
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <div class="col-md-4">
                <h3>보낸 친구 요청</h3>
                <table class="table table-hover table-bordered mt-3">
                    <thead class="table-light">
                    <tr>
                        <th>친구 ID</th>
                        <th>상태</th>
                        <th>작업</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${#lists.isEmpty(sentRequests)}">
                        <td colspan="3">
                            <div class="empty-state">
                                <i class="fas fa-paper-plane"></i>
                                <p>보낸 친구 요청이 없습니다.</p>
                            </div>
                        </td>
                    </tr>
                    <tr th:each="friend : ${sentRequests}" th:unless="${#lists.isEmpty(sentRequests)}">
                        <td th:text="${friend.friendId}">친구 ID</td>
                        <td>대기 중</td>
                        <td>
                            <button class="btn btn-danger btn-sm cancel-sent-btn" th:data-friend-id="${friend.friendId}"
                                    type="button">
                                요청 취소
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 친구 검색 모달 -->
        <div aria-hidden="true" aria-labelledby="friendSearchModalLabel" class="modal fade" id="friendSearchModal"
             tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="friendSearchModalLabel">아이디로 친구 검색</h5>
                        <button aria-label="Close" class="btn-close" data-bs-dismiss="modal" type="button"></button>
                    </div>
                    <div class="modal-body">
                        <input class="form-control" id="searchFriendId" placeholder="아이디를 입력하세요" type="text">
                        <button class="btn btn-secondary w-100 mt-2" id="searchFriendButton" type="button">검색</button>
                        <div class="mt-3" id="searchResult"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- scripts 프래그먼트 -->
<div layout:fragment="scripts">
    <script>
        $(document).ready(function () {
            $(".delete-friend-btn").on("click", function () {
                const friendId = $(this).data("friend-id");
                if (confirm("이 친구를 삭제하시겠습니까?")) {
                    $.post("/friendships/deleteFriend", {friendId: friendId}, function (response) {
                        alert("친구가 삭제되었습니다.");
                        window.location.reload();
                    }).fail(function () {
                        alert("친구 삭제 중 오류가 발생했습니다.");
                    });
                }
            });

            $(".accept-btn").on("click", function () {
                const requestId = $(this).data("request-id");
                if (confirm("친구 요청을 수락하시겠습니까?")) {
                    $.post("/friendships/acceptRequest", {friendshipId: requestId}, function (response) {
                        alert("친구 요청을 수락했습니다.");
                        window.location.reload();
                    }).fail(function () {
                        alert("수락 중 오류가 발생했습니다.");
                    });
                }
            });

            $(".decline-btn").on("click", function () {
                const requestId = $(this).data("request-id");
                if (confirm("친구 요청을 거절하시겠습니까?")) {
                    $.post("/friendships/declineRequest", {friendshipId: requestId}, function (response) {
                        alert("친구 요청을 거절했습니다.");
                        window.location.reload();
                    }).fail(function () {
                        alert("거절 중 오류가 발생했습니다.");
                    });
                }
            });

            $(".cancel-sent-btn").on("click", function () {
                const friendId = $(this).data("friend-id");
                if (confirm("친구 요청을 취소하시겠습니까?")) {
                    $.post("/friendships/cancelRequest", {friendId: friendId}, function (response) {
                        alert("친구 요청을 취소했습니다.");
                        window.location.reload();
                    }).fail(function () {
                        alert("취소 중 오류가 발생했습니다.");
                    });
                }
            });

            $("#searchFriendButton").on("click", performSearch);
            $("#searchFriendId").on("keyup", function (event) {
                if (event.key === "Enter") {
                    performSearch();
                }
            });

            function performSearch() {
                const friendId = $("#searchFriendId").val();
                if (friendId.length > 0) {
                    $.get("/friendships/checkUser", {friendId: friendId}, function (data) {
                        if (data.exists) {
                            let name = data.name ? data.name : "본인입니다";
                            let buttonHtml = "";
                            if (data.isSelf) {
                                buttonHtml = `<button type="button" class="btn btn-secondary" disabled>본인입니다</button>`;
                            } else if (data.isFriend) {
                                buttonHtml = `<button type="button" class="btn btn-secondary" disabled>이미 친구입니다</button>`;
                            } else if (data.hasPendingRequest) {
                                buttonHtml = `<button type="button" class="btn btn-secondary" disabled>친구 요청을 보냈습니다</button>`;
                            } else {
                                buttonHtml = `<button type="button" class="btn btn-success" id="sendFriendRequestButton">친구 요청 보내기</button>`;
                            }
                            $("#searchResult").html(`
                                <div class="d-flex align-items-center border p-3">
                                    <div class="me-3">
                                        <img src="${data.profileImg ? "/files/" + data.profileImg : "/images/default-profile.png"}" alt="프로필 이미지" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
                                    </div>
                                    <div class="flex-grow-1">
                                        <strong>${friendId}</strong><br>
                                        <span>${name}</span>
                                    </div>
                                    <div>${buttonHtml}</div>
                                </div>
                            `);

                            if (data.profileImg) {
                                $("#profile-img").attr("src", data.profileImg);
                            }

                            if (!data.isSelf && !data.isFriend && !data.hasPendingRequest) {
                                $("#sendFriendRequestButton").on("click", function () {
                                    $.post("/friendships/sendRequest", {friendId: friendId}, function (response) {
                                        alert("친구 요청을 보냈습니다!");
                                        $("#friendSearchModal").modal("hide");
                                        window.location.reload();
                                    }).fail(function () {
                                        alert("친구 요청 중 오류가 발생했습니다.");
                                    });
                                });
                            }
                        } else {
                            $("#searchResult").html(`<p>${friendId}는 존재하지 않는 아이디입니다.</p>`);
                        }
                    }).fail(function () {
                        $("#searchResult").html("<p>오류가 발생했습니다.</p>");
                    });
                } else {
                    $("#searchResult").html("<p>아이디를 입력하세요.</p>");
                }
            }
        });
    </script>
</div>